<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>

<script type="text/ruby" src="ruby/settings.rb"></script>
<script type="text/javascript" src="js/stacktrace.js"></script>
<script type="text/javascript" src="js/p2pdocs.js"></script>
<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>

<link rel="stylesheet" type="text/css" href="css/p2pdocs.css" />

<script type="text/javascript">
function configApp() {
  // Initialize the basic setup.
  if (!Titanium.App.Properties.hasProperty('settings-dir')) {
    // Titanium.App.Properties pulls from the application.properties file.  Note that lines in it beginning with # sometimes disappear; I use // for commentary.
    Titanium.App.Properties.setString('settings-dir', Titanium.Filesystem.getApplicationDataDirectory().toString());
  }
  
  // Initialize a DB for genealogy tree-of-interest.
  var genealogyDB = Titanium.Database.open("genealogy");
  // ext_ids is a JSON-encoded array of IDs
  var exec = genealogyDB.execute('CREATE TABLE IF NOT EXISTS genealogy (id INTEGER PRIMARY KEY AUTOINCREMENT, father_id INTEGER, mother_id INTEGER, ext_ids TEXT)');
  genealogyDB.close();
  Titanium.App.Properties.setString('genealogy_db_path', genealogyDB.getPath());
}

try {
  // giving it a name for potential stack traces
  configApp();
} catch (e) {
  p2pdocsHandleError(e);
}
</script>

<script type="text/ruby">
  window.p2pdoc_settings = Settings.new(Titanium.App.Properties.getString("settings-dir"))
</script>

<script type="text/javascript">

var setupFinished = false;

function redirectWhenSetupFinished(url) {
  if (setupFinished) {
    window.location.href = url;
  } else {
    setTimeout('redirectWhenSetupFinished("'+url+'")', 100);
  }
}

function startApp() {
  
  // coordinate the version in nodeApp.js with this one
  var thisVersion = parseFloat(Titanium.App.getVersion());
  
  //Titanium.UI.getWindows()[0].showInspector(true);
  //Titanium.API.print("to console\n");
  
  /** This doesn't work: gotta save and retrieve the version from our settings.
  if (parseFloat(Titanium.App.getVersion()) < 8.0) {
    settingsFile = window.p2pdoc_settings.settings_file().toString();
    reviewedDir = window.p2pdoc_settings.reviewed_base_dir().toString();
    message = 
      "Congratulations, Early Adopter!  Unfortunately, your reward is a manual task: "
      + "\n\nOpen this file in a text editor: " + settingsFile 
      + "\n\nOpen this directory: " + reviewedDir 
      + "\n\nRename each folder in the directory to the 'id' number in the file.\n\nClick 'OK' to continue.";
    if (!confirm(message)) {
      Titanium.App.exit();
    }
  }
  **/
  
  // run the node server
  var platform = Titanium.getPlatform();
  //if (platform === 'win') {
  //  alert("Many functions will not work because the Windows platform is not supported yet.  I wouldn't even try.");
  //}
  var sep = Titanium.Filesystem.getSeparator();
  var binRoot = Titanium.App.getHome() + sep + 'Resources';
  var nodeBinary = binRoot + sep + 'nodejs' + sep + 'builds' + sep + platform + sep + 'node' + sep + 'bin' + sep + 'node';
  var appServerPath = binRoot + sep + 'nodeApp.js';
  if (!Titanium.Filesystem.getFile(nodeBinary).isExecutable()) {
    Titanium.Filesystem.getFile(nodeBinary).setExecutable();
  }
  var nodeProcess = Titanium.Process.createProcess(["nohup", nodeBinary, appServerPath]);
  // I'd like to attach to all the pipes (eg. stdout, stderr) in the subprocess, but I can't find the handles to the pipes in the main app.
  nodeProcess.setOnRead(function(data) {
    // This will fire on console.log, warn, and trace; all others will go directly to output.
    Titanium.API.info("node console.log: " + data.getData());
  });
  nodeProcess.launch(); // they say this is deprecated, but mine doesn't run without it
  Titanium.API.addEventListener(Titanium.EXIT, function(e) {
    nodeProcess.kill();
  });
  
  // detect a different version of the node server, which can happen when the app crashes and node keeps running
  // (We have to wait, because if we do it immediately then the node server isn't 100% initialized.  It typically takes 1100 millis.)
  setTimeout(function() {
    $.ajax({
      url:"http://127.0.0.1:1338/version",
      error:function(err) {
        // OK, this is very bad: why is there an error retrieving the version?
        alert("Part of this service is not running correctly.  For best results, kill the 'node' program or restart your computer.  (Error Code: index.html 1)");
        setupFinished = true;
      },
      success:function(data) {
        nodeVersion = JSON.parse(data);//parseFloat(JSON.parse(data));
        if (nodeVersion < thisVersion) {
          // Yep, we've got a node process running from a previous version of the app.  Ug.
          alert("Part of this service is not running correctly.  For best results, kill the 'node' program or restart your computer.  (Error Code: index.html 2)");
        }
        setupFinished = true;
      }
    });
  }, 1500);
  
  // redirect to the correct first page
  var settingsFile = Titanium.Filesystem.getFile(window.p2pdoc_settings.settings_file());
  if (settingsFile.exists()) {
    redirectWhenSetupFinished("change-summary.html?redirectIfNoUpdates=");
  } else {
    redirectWhenSetupFinished("repository.html");
  }
}

try {
  // giving it a name for potential stack traces
  startApp();
} catch (e) {
  p2pdocsHandleError(e);
}

</script>
</head>
<body>
  <h1 style="text-align:center;">Loading...</h1>
</body>
</html>
