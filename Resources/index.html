<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
</head>
<script type="text/ruby" src="ruby/settings.rb"></script>
<script type="text/javascript" src="js/stacktrace.js"></script>
<script type="text/javascript" src="js/p2pdocs.js"></script>
<script type="text/javascript">
function setupApp() {
  // Initialize the basic setup.
  if (!Titanium.App.Properties.hasProperty('settings-dir')) {
    // Titanium.App.Properties pulls from the application.properties file.  Note that lines in it beginning with # sometimes disappear; I use // for commentary.
    Titanium.App.Properties.setString('settings-dir', Titanium.Filesystem.getApplicationDataDirectory().toString());
  }
  // Initialize a DB table for passing around actions.
  var sessionDB = Titanium.Database.open("sessionDB");
  var exec = sessionDB.execute('CREATE TABLE IF NOT EXISTS action (data TEXT)');
  sessionDB.close();
}

try {
  // giving it a name for potential stack traces
  setupApp();
} catch (e) {
  p2pdocsHandleError(e);
}  
</script>

<script type="text/ruby">
  window.p2pdoc_settings = Settings.new(Titanium.App.Properties.getString("settings-dir"))
</script>

<script type="text/javascript">
  //Titanium.UI.getWindows()[0].showInspector(true);
  //Titanium.API.print("to console\n");
  
  // run the node server
  var platform = Titanium.getPlatform();
  if (platform === 'win') {
    alert("Many functions will not work because the Windows platform is not supported yet.  I wouldn't even try.");
  }
  var sep = Titanium.Filesystem.getSeparator();
  var binRoot = Titanium.App.getHome() + sep + 'Resources';
  var nodeBinary = binRoot + sep + 'nodejs' + sep + 'builds' + sep + platform + sep + 'node' + sep + 'bin' + sep + 'node';
  var appServerPath = binRoot + sep + 'nodeApp.js';
  if (!Titanium.Filesystem.getFile(nodeBinary).isExecutable()) {
    Titanium.Filesystem.getFile(nodeBinary).setExecutable();
  }
  var nodeProcess = Titanium.Process.createProcess(["nohup", nodeBinary, appServerPath]);
  nodeProcess.launch(); // they say this is deprecated, but mine doesn't run without it
  Titanium.API.addEventListener(Titanium.EXIT, function(e) {
    nodeProcess.kill();
  });

  
  // redirect to the correct first page
  var settingsFile = Titanium.Filesystem.getFile(window.p2pdoc_settings.settings_file());
  if (settingsFile.exists()) {
    window.location.href= "change-summary.html?redirectIfNoUpdates=";
  } else {
    window.location.href= "repository.html";
  }
  
</script>
</html>
