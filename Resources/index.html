<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title>P2P Docs</title>

<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>

<link type="text/css" href="css/smoothness/jquery-ui-1.8.13.custom.css" rel="stylesheet"/>

<style>
#fullContent {
  position: relative;
}

#repoList {
  float:left;
  width:450px;
}

#sideActionWrapper { /* required to avoid jumping */
  left: 450px;
  position: absolute;
  margin-left: 35px;
  width:280px;
}

#sideAction {
  position: absolute;
  top: 0;
  margin-top: 20px;
  border-top: 1px solid purple;
  padding-top: 19px;
}

#sideAction.fixed {
  position: fixed;
  top: 0;
}
</style>

<script type="text/ruby"       src="ruby/settings.rb"></script>
<script type="text/ruby"       src="ruby/updates.rb"></script>

<script type="text/ruby">
  window.p2pdoc_settings = Settings.new(Titanium.App.Properties.getString("settings-dir"))
  window.p2pdoc_all_diffs_json = Updates.strings_arrays_hashes_json(Updates.all_repo_diffs(window.p2pdoc_settings))
  window.p2pdoc_mark_reviewed = lambda {|repo, path| Updates.mark_reviewed(window.p2pdoc_settings, repo, path)}
</script>

<script type="text/javascript">

//Titanium.UI.getWindows()[0].showInspector()
var Ti = {fs: Titanium.Filesystem, api:Titanium.API};

function allProps(the_obj) {
  var str = "";
  for (prop in the_obj) {
    str += prop + " value: "+ the_obj[prop]+"\n";
  }
  return str;
}

function markAccepted() {
  $('input[type="checkbox"]').each(function() {
    var repoName, path;
    if ($(this).is(":checked")) {
      repoName = $(this).attr("repoName");
      path = $(this).attr("path");
      window.p2pdoc_mark_reviewed(repoName, path);
      $(this).parent().hide(500);
    }
  });
}

function viewFileWrapperFunc(sourceDir, path) {
  var viewFileFunc = function() {
    var file = sourceDir + "/" + path;
    try {
      var result = Titanium.Platform.openApplication(file);
      if (result !== "true"     // The API says that the result is a string...
          && result !== true) { // ... but I'm getting a boolean result.
        alert("Sorry!  We had a problem opening that file.  If you report this problem, the following info will help.\nfile: " + file + "\nresult: " + result);
        throw 10;
      }
    } catch (err) {
      var errDebug = "";
      for (var prop in err) {
         errDebug += "property: " + prop + " value: [" + err[prop] + "]\n";
      }
      errDebug += "toString(): " + " value: [" + err.toString() + "]";
      alert("Sorry!  We had a problem opening that file.  If you report this problem, the following info will help.\nfile: " + file + "\n" + errDebug);
    }
    return false;
  }
  return viewFileFunc;
}

$(document).ready(function() {

  try {
    var all_diffs = JSON.parse(window.p2pdoc_all_diffs_json);
    if (all_diffs.length > 0) {

      $('#diff').show();
      $('#same').hide();

      // declare the repo variables for data and DOM elements
      var repoCount, oneRepoDiffs, repoData, repoName, repoDiffList, repoDiffCount;
      var repoTemplate, addedRepo, numChanges;
      // declare the diff variables for data and DOM elements
      var diffSet;
      var diffTemplate, addedDiff, numFiles;
      
      repoCount = all_diffs.length;
      repoTemplate = $('#repoList #repo_');
      
      for (var repoNum = 0; repoNum < repoCount; repoNum++) {
        oneRepoDiffs = all_diffs[repoNum];
        repoName = oneRepoDiffs.name;
        repoDiffList = oneRepoDiffs.diffs;
        repoDiffCount = repoDiffList.length;
        
        addedRepo = repoTemplate.clone();
        addedRepo.insertBefore(repoTemplate);
        addedRepo.show();
        addedRepo.attr("id", "repo_" + repoNum);
        addedRepo.find("#repoName_").attr("id", "repoName_" + repoNum).html(repoName);
        numChanges = repoDiffCount + " " + (repoDiffCount == 1 ? "change" : "changes");
        addedRepo.find("#repoDiffCount_").attr("id", "repoDiffCount_" + repoNum).html("(" + numChanges + ")");
        
        diffTemplate = addedRepo.find('#diff_');
        
        for (var diffNum = 0; diffNum < repoDiffCount; diffNum++) {
          diffSet = repoDiffList[diffNum];
          
          addedDiff = diffTemplate.clone();
          addedDiff.insertBefore(diffTemplate);
          addedDiff.show();
          addedDiff.attr("id", "diff_" + diffNum);
          addedDiff.find("#reviewed_").attr("id", "reviewed_" + diffNum).attr("repoName", repoName).attr("path", diffSet.path);
          
          addedDiff.find("#diffPath_").attr("id", "diffPath_" + diffNum).html(diffSet.path);
          if (diffSet.source === "file") {
            if (diffSet.reviewed == null) {
              repoData = window.p2pdoc_settings.get_repo(repoName);
              addedDiff.find("#sourceView a").click(viewFileWrapperFunc(repoData.source_dir, diffSet.path)).show();
            } else {
              // there's another file or something that's been reviewed
              if (diffSet.reviewed === "file") {
                repoData = window.p2pdoc_settings.get_repo(repoName);
                file1 = repoData.source_dir + Titanium.Filesystem.getSeparator() + diffSet.path;
                file2 = window.p2pdoc_settings.reviewed_dir(repoName) + Titanium.Filesystem.getSeparator() + diffSet.path;
                addedDiff.find("#changeView a").attr("href", "changes.html?file1=" + file1 + "&file2=" + file2).show();
              } else {
                // it's something other than a file
                addedDiff.find("#strangeView a").show();
              }
            }
          }
          if (diffSet.contents != null) {
            // show the count
            numFiles = diffSet.contents.length + " " + (diffSet.contents.length == 1 ? "file" : "files");
            addedDiff.find("#diffCount_").attr("id", "diffCount_" + diffNum).html(numFiles);
            // populate the contents
            var fileList = "";
            for (var fileNum = 0, fileCount = diffSet.contents.length; fileNum < fileCount; fileNum++) {
              fileList += "<li>" + diffSet.contents[fileNum] + "</li>\n";
            }
            addedDiff.find("#showContents a").after("<ul>" + fileList + "</ul>");
            addedDiff.find("#showContents a").next().hide();
            // add a toggling function
            addedDiff.find("#showContents a").click(function() {
              $(this).next().toggle(500);
              return false;
            }).show();
          }
        }
      }
    }

    // click to toggle panel
    $('.panelHeader').click(function() {
      $(this).next().toggle(500);
      return false;
    }).next().hide();
    
    // from http://jqueryfordesigners.com/fixed-floating-elements/
    var top = $('#sideAction').offset().top - parseFloat($('#sideAction').css('margin-top').replace(/auto/, 0));
    $(window).scroll(function (event) {
      // what the y position of the scroll is
      var y = $(this).scrollTop();
      
      // whether that's below the form
      if (y >= top) {
        // if so, ad the fixed class
        $('#sideAction').addClass('fixed');
      } else {
        // otherwise remove it
        $('#sideAction').removeClass('fixed');
      }
    });

  } catch (e) {
    alert('error: ' + e);
  }

});
</script>
</head>
<body>

<a href="repositories.html" style="float:right;">settings</a>

<h4 id="same">Nothing to see.</h4>
<h4 id="diff" style="display:none;">You've got changes!</h4>

<div id="fullContent">
  <div id="repoList">
    <div id="repo_" class="accordion" style="display:none;">
      <h3 class="panelHeader">
        <a href="#">
          <span id="repoName_">repo</span>
          <span id="repoDiffCount_">count</span>
        </a>
      </h3>
      <div>
        <div id="diff_" style="display:none;">
          <input type="checkbox" id="reviewed_" repo="_" path="_">
          <span id="diffPath_">path</span>
          <span id="sourceView"><a href="#" style="display:none;">(view)</a></span>
          <span id="changeView"><a href="#" style="display:none;">(changes)</a></span>
          <span id="strangeView"><a href="#" style="display:none;" onClick="javascript: alert('The source is an object of a different type, so something very strange happened to this thing.');">(strange)</a></span>
          <span id="showContents"><a href="#" style="display:none;">(<span id="diffCount_">count</span>)</a></span>
        </div>
      </div>
    </div>
  </div>
  
  <div id="sideActionWrapper">
    <div id="sideAction">
      <a href="#" onclick="javascript: markAccepted(); return false;">Accept</a>
    </div>
  </div>

</div>

</body>
</html>
