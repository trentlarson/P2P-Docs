<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>

  <link rel="stylesheet" type="text/css" href="css/p2pdocs.css" />
  
  <script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
  <script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>
  <script type="text/javascript" src="js/p2pdocs.js"></script>
  
  <script type="text/ruby"       src="ruby/settings.rb"></script>
  <!-- Since Titanium has problems when these files require each other, we're listing them separately -->
  <script type="text/ruby"       src="ruby/lib/gedcom_date_parser.rb"></script>
  <script type="text/ruby"       src="ruby/lib/gedcom_date.rb"></script>
  <script type="text/ruby"       src="ruby/lib/gedcom.rb"></script>
  <script type="text/ruby"       src="ruby/gedcom-ancestry.rb"></script>
  <script type="text/ruby"       src="ruby/p2pdocs_utils.rb"></script>
  
  <script type="text/ruby">
    window.p2pdoc_settings = Settings.new(Titanium.App.Properties.getString("settings-dir"))
    window.p2pdoc_ancestor_search = newSimilarNameExtractor()
  </script>
  
  <script>
    $(document).ready(function() {
      
      if (urlParam("nameInFile")
          && urlParam("genLocation")) {
        window.p2pdoc_ancestor_search.setNamesToMatch(urlParam("nameInFile"));
        window.p2pdoc_ancestor_search.parse(urlParam("genLocation"));
        alert(window.p2pdoc_ancestor_search.similarPeopleFoundJson());
      }
      
      if (urlParam("idInFile")
          && urlParam("genLocation")) {
        window.p2pdoc_settings.add_identity(urlParam("genLocation"), urlParam("idInFile"));
        $('#everything').hide('slide', { direction: "down"}, 500, function() {
          location.href = "repositories.html";
        });
      }
      
      $("#identitySearchForm").submit(function() {
        // only submit if both are filled in
        if ($("#nameInFile").val().length > 0
            && $("#genLocation").val().length > 0) {
          // allow submit
          return true;
        } else {
          alert("Please enter a name along with a file.");
          return false;
        }
      });
      
      $("#identityDataForm").submit(function() {
        // only submit if both are filled in
        if ($("#idInFile").val().length > 0
            && $("#genLocation").val().length > 0) {
          // allow submit
          return true;
        } else {
          alert("Please enter an ID along with a file.");
          return false;
        }
      });
      
      $('#cancel').bind('click', function() {
        $('#everything').hide('slide', { direction: "down"}, 500, function() {
          location.href = "repositories.html";
        });
      });
      
      $("#chooseFile").click(function() {
        Titanium.UI.getCurrentWindow().openFileChooserDialog(function(selectionResponse) {
          if (selectionResponse.length > 0) {
            $("#genLocation").val(selectionResponse[0]);
          }
        });
      });
      
    });
  </script>

</head>
<body>
  
  <div id="everything" style="text-align:center; height:100%;">
    
    <span id="cancel" class="link">Cancel</span>
    <br/>
    
    <h2>Search</h2>
    <form action="identity.html" id="identitySearchForm">
      Enter the name of yourself or your closest ancestor: <input type="text" name="nameInFile" id="nameInFile">
      <br/>
       ... from the genealogy file: <input type="text" name="genLocation" id="genLocation"> <span id="chooseFile" class="link">(select file)</span>
      <br/>
      <input type="submit" value="find matches">
    </form>
    
    <h2>Raw Data</h2>
    <form action="identity.html" id="identityDataForm">
      Enter the ID of yourself or your closest ancestor: <input type="text" name="idInFile" id="idInFile">
      <br/>
       ... from the genealogy file: <input type="text" name="genLocation" id="genLocation"> <span id="chooseFile" class="link">(select file)</span>
      <br/>
      <input type="submit" value="add identity">
    </form>
    
  </div>
</body>
</html>