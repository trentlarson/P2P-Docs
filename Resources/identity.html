<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>

  <link rel="stylesheet" type="text/css" href="css/p2pdocs.css" />
  
  <script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
  <script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>
  <script type="text/javascript" src="js/p2pdocs.js"></script>
  
  <script type="text/ruby"       src="ruby/settings.rb"></script>
  <!-- Since Titanium has problems when these files require each other, we're listing them separately -->
  <script type="text/ruby"       src="ruby/lib/gedcom_date_parser.rb"></script>
  <script type="text/ruby"       src="ruby/lib/gedcom_date.rb"></script>
  <script type="text/ruby"       src="ruby/lib/gedcom.rb"></script>
  <script type="text/ruby"       src="ruby/gedcom-ancestry.rb"></script>
  <script type="text/ruby"       src="ruby/p2pdocs_utils.rb"></script>
  
  <script type="text/javascript">
    var appPropsStr = Ti.App.Properties.getString("appPropsJson");
    var appProps = JSON.parse(appPropsStr);
    window.settingsDir = appProps['settings-dir'];
  </script>

  <script type="text/ruby">
    window.p2pdoc_settings = Settings.new(window.settingsDir)
    window.p2pdoc_ancestor_search = newSimilarNameExtractor()
    window.p2pdoc_ancestor_tree = newTreeExtractor()
  </script>
  
</head>
<body>
  
  <div id="everything" style="text-align:center; height:100%;">
    
    <span id="cancel" class="link">Cancel</span>
    <br/>
    
    <h2>URL</h2>
    <form action="identity.html" id="identityUrlDataForm">
      Enter the public URL of your closest ancestor (or yourself): <input type="text" name="idUrl" id="idUrl">
      <br/>
      <input type="submit" value="add identity URL">
    </form>
    
    <h2>Search</h2>
    <form action="identity.html" id="identitySearchForm">
      Enter the name of yourself or your closest ancestor: <input type="text" name="nameInFile" id="nameInFile">
      <br/>
       ... from the genealogy file: <input type="text" name="genLocation" id="genLocation"> <span id="chooseFile" class="link">(select file)</span>
      <br/>
      <input type="submit" value="find matches">
    </form>
    
    <div style="text-align:left;">
      <ul>
        <li id="match" style="display:none;"><span id="matchName"></span>  <span id="acceptMatch" class="link">Yes!  This is me or a close ancestor.</span></li>
      </ul>
    </div>
    
    <h2>Raw File Data</h2>
    <form action="identity.html" id="identityFileDataForm">
      Enter the ID of yourself or your closest ancestor: <input type="text" name="idInFile" id="idInFile">
      <br/>
       ... from the genealogy file: <input type="text" name="genLocation" id="genLocation"> <span id="chooseFile" class="link">(select file)</span>
      <br/>
      <input type="submit" value="add identity from file">
    </form>
    
  </div>
  
  <script>
    
    $(document).ready(function() {
      
      if (urlParam("idUrl")) {
        alert("not implemented: must save it and work up the tree if recognized");
      }
      
      if (urlParam("nameInFile")
          && urlParam("genLocation")) {
        var genLocation = urlParam("genLocation");
        window.p2pdoc_ancestor_search.setNamesToMatch(urlParam("nameInFile"));
        window.p2pdoc_ancestor_search.parse(genLocation);
        var resultString = window.p2pdoc_ancestor_search.similarPeopleFoundJson();
        var resultJson = JSON.parse(resultString);
        var matchTemplate = $('#match');
        var newMatch;
        for (var i = 0; i < resultJson.length; i++) {
          newMatch = matchTemplate.clone();
          newMatch.insertBefore(matchTemplate);
          newMatch.find('#matchName').html(resultJson[i].name);
          newMatch.show();
          newMatch.find('#acceptMatch').click(function(file, indId) {
            return function() {
              location.href = "identity.html?gedcomFile=" + escape(file) + "&indId=" + escape(indId);
            };
          }(genLocation, resultJson[i].indId));
        }
      }
      
      if (urlParam("indId")
          && urlParam("gedcomFile")) {
        window.p2pdoc_settings.add_identity(urlParam("gedcomFile"), urlParam("indId"));
        window.p2pdoc_ancestor_tree.parse(urlParam("gedcomFile"));
        //var treeString = window.p2pdoc_ancestor_tree.retrieveTreeJson(urlParam("indId"));
        // (We really should store this with our settings rather than application.properties.)
        //appProps['ancestry'] = JSON.parse(treeString);
        var listString = window.p2pdoc_ancestor_tree.retrieveTreeAsUrlListJson(urlParam("gedcomFile"), urlParam("indId"));
        // (We really should store this with our settings rather than application.properties.)
        appProps['ancestryIds'] = JSON.parse(listString);
        Ti.App.Properties.setString('appPropsJson', JSON.stringify(appProps));
        var message = "Your ancestry has been indexed and saved.";
        $('#everything').hide('slide', { direction: "down"}, 500, function() {
          location.href = "repositories.html?message=" + escape(message);
        });
      }
      
      if (urlParam("idInFile")
          && urlParam("genLocation")) {
        window.p2pdoc_settings.add_identity(urlParam("genLocation"), urlParam("idInFile"));
        $('#everything').hide('slide', { direction: "down"}, 500, function() {
          location.href = "repositories.html?message=" + escape("Identity saved.  However, we haven't stored your full ancestry.");
        });
      }
      
      $("#identityUrlDataForm").submit(function() {
        // only submit if URL is filled in
        if ($("#idUrl").val().length > 0) {
          // allow submit
          return true;
        } else {
          alert("Please enter a URL.");
          return false;
        }
      });
      
      $("#identitySearchForm").submit(function() {
        // only submit if both are filled in
        if ($("#nameInFile").val().length > 0
            && $("#genLocation").val().length > 0) {
          // allow submit
          return true;
        } else {
          alert("Please enter a name along with a file.");
          return false;
        }
      });
      
      $("#identityFileDataForm").submit(function() {
        // only submit if both are filled in
        if ($("#idInFile").val().length > 0
            && $("#genLocation").val().length > 0) {
          // allow submit
          return true;
        } else {
          alert("Please enter an ID along with a file.");
          return false;
        }
      });
      
      $('#cancel').bind('click', function() {
        $('#everything').hide('slide', { direction: "down"}, 500, function() {
          location.href = "repositories.html";
        });
      });
      
      $("#chooseFile").click(function() {
        Ti.UI.getCurrentWindow().openFileChooserDialog(function(selectionResponse) {
          if (selectionResponse.length > 0) {
            $("#genLocation").val(selectionResponse[0]);
          }
        });
      });
      
    });
    
  </script>
  
</body>
</html>
