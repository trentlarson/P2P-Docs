<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title>P2P Docs</title>

<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>
<script type="text/javascript" src="js/p2pdocs.js"></script>

<link type="text/css" href="css/smoothness/jquery-ui-1.8.13.custom.css" rel="stylesheet"/>

<style>
#inChanges {
  position: relative;
}

#repoList {
  float:left;
  width:450px;
}

#sideActionWrapper { /* required to avoid jumping */
  left: 450px;
  position: absolute;
  margin-left: 35px;
  width:280px;
}

#sideAction {
  position: absolute;
  top: 0;
  padding-top: 30px;
}

#sideAction.fixed {
  position: fixed;
  top: 0;
}
</style>

<script type="text/ruby"       src="ruby/settings.rb"></script>
<script type="text/ruby"       src="ruby/updates.rb"></script>

<script type="text/javascript">
  // Initialize the basic setup.
  if (!Titanium.App.Properties.hasProperty('settings-dir')) {
    // Titanium.App.Properties pulls from the application.properties file.  Note that lines in it beginning with # sometimes disappear; I use // for commentary.
    Titanium.App.Properties.setString('settings-dir', Titanium.Filesystem.getApplicationDataDirectory().toString());
  }
</script>
<script type="text/ruby">
  window.p2pdoc_settings = Settings.new(Titanium.App.Properties.getString("settings-dir"))
  window.p2pdoc_all_diffs_json = Updates.strings_arrays_hashes_json(Updates.all_repo_diffs(window.p2pdoc_settings))
  window.p2pdoc_all_out_diffs_json = Updates.strings_arrays_hashes_json(Updates.all_outgoing_diffs(window.p2pdoc_settings))
  def copy_to_outgoing(out_diffs)
    out_diffs.each { |name_diff|
      name_diff.diffs.each { |diff|
        Updates.copy_to_outgoing(window.p2pdoc_settings, name_diff.name, diff.path)
      }
    }
  end
  window.p2pdoc_copy_to_outgoing = lambda { |all_diffs| all_diffs.each { |name_diff| Updates.copy_all_to_outgoing(window.p2pdoc_settings, name_diff['name'], name_diff['diffs']) } }
  window.p2pdoc_mark_reviewed = lambda { |repo_name, path, previous_path| Updates.mark_reviewed(window.p2pdoc_settings, repo_name, path, previous_path) }
</script>

<script type="text/javascript">

//Titanium.UI.getWindows()[0].showInspector()
//Titanium.API.print("to console\n");
var Ti = {fs: Titanium.Filesystem, api:Titanium.API};

function allProps(the_obj) {
  var str = "";
  for (prop in the_obj) {
    str += prop + " value: "+ the_obj[prop]+"\n";
  }
  return str;
}

function markAccepted() {
  var checkedBoxes = $('input[type="checkbox"]:checked');
  if (checkedBoxes.length == 0) {
    alert("If you really want to accept something, you'll have to select it first.");
  } else {
    checkedBoxes.each(function() {
      var repoName, path;
      repoName = $(this).attr("repoName");
      path = $(this).attr("path");
      previousPath = $(this).attr("previousPath");
      window.p2pdoc_mark_reviewed(repoName, path, previousPath);
      var repoDiv = $(this).parent().parent().parent();
      $(this).parent().hide(500, function() {
        $(this).remove();
        // now hide the repo if that was the last child
        if (repoDiv.find('#diffList').children().length == 1) {
          repoDiv.hide(500, function() {
            repoDiv.remove();
            // now revert to default display if that was the last repo
            if ($('#inChanges #repoList').children().length == 1) {
              $('#sideActionWrapper').hide(500);
              $('#noDiffs').show(500);
            }
            $(this).remove();
          });
        }
      });
    });
  }
}

$(document).ready(function() {

  try {
    
    if (window.p2pdoc_settings.properties().repositories.length > 0) {
      $('#noRepos').hide();
      
      // show the copy-to-outgoing action
      var allOutDiffs = JSON.parse(window.p2pdoc_all_out_diffs_json);
      if (allOutDiffs.length > 0) {
        var outCount = allOutDiffs.length;
        for (var outRepoNum = 0; outRepoNum < outCount; outRepoNum++) {
          $('#outChangeList').append(allOutDiffs[outRepoNum].name);
          $('#outChangeList').append("<ul>\n");
          var outChangeCount = allOutDiffs[outRepoNum].diffs.length;
          for (var outChangeNum = 0; outChangeNum < outChangeCount; outChangeNum++) {
            $('#outChangeList').append("<li>" + allOutDiffs[outRepoNum].diffs[outChangeNum].path + "</li>\n");
          }
          $('#outChangeList').append("</ul>\n");
        }
        $('#exportOutChanges').click(function() {
            copy_to_outgoing(allOutDiffs);
            $(this).hide(500);
            return false;
        });
        $('#previewOutgoing').click(function() {
          $(this).next().toggle(500);
        });
        $('#outChanges').show();
      }
      
      // show the incoming-review action
      var all_diffs = JSON.parse(window.p2pdoc_all_diffs_json);
      if (all_diffs.length == 0) {
        $('#noDiffs').show();
        
      } else {
        $('#sideActionWrapper').show();
  
        // declare the repo variables for data and DOM elements
        var repoCount, repoTemplate, oneRepoDiffs, repoName, repoDiffList, repoDiffCount, addedRepo;
        var repoData, numChanges;
        // declare the diff variables for data and DOM elements
        var diffSet;
        var diffTemplate, addedDiff, numFiles;
        
        repoCount = all_diffs.length;
        repoTemplate = $('#inChanges #repoList #repo_');
        
        for (var repoNum = 0; repoNum < repoCount; repoNum++) {
          oneRepoDiffs = all_diffs[repoNum];
          repoName = oneRepoDiffs.name;
          repoDiffList = oneRepoDiffs.diffs;
          repoDiffCount = repoDiffList.length;
          
          addedRepo = repoTemplate.clone();
          addedRepo.insertBefore(repoTemplate);
          addedRepo.show();
          addedRepo.attr("id", "repo_" + repoNum);
          addedRepo.find("#repoName_").attr("id", "repoName_" + repoNum).html(repoName);
          numChanges = repoDiffCount + " " + (repoDiffCount == 1 ? "change" : "changes");
          addedRepo.find("#repoDiffCount_").attr("id", "repoDiffCount_" + repoNum).html("(" + numChanges + ")");
          
          diffTemplate = addedRepo.find('#diff_');
          
          for (var diffNum = 0; diffNum < repoDiffCount; diffNum++) {
            diffSet = repoDiffList[diffNum];
            
            addedDiff = diffTemplate.clone();
            addedDiff.insertBefore(diffTemplate);
            addedDiff.show();
            addedDiff.attr("id", "diff_" + diffNum);
            addedDiff.find("#reviewed_").attr("id", "reviewed_" + diffNum)
              .attr("repoName", repoName)
              .attr("path", diffSet.path)
              .attr("previousPath", diffSet.target_path_previous_version);
            
            addedDiff.find("#diffPath_").attr("id", "diffPath_" + diffNum).html(diffSet.path);
            if (diffSet.source_type === "file") {
              if (diffSet.target_type == null) {
                repoData = window.p2pdoc_settings.get_repo_by_name(repoName);
                addedDiff.find("#sourceView a").click(viewFileWrapperFunc(repoData.incoming_loc, diffSet.path)).show();
              } else {
                // there's another file or something that's been reviewed
                if (diffSet.target_type === "file") {
                  repoData = window.p2pdoc_settings.get_repo_by_name(repoName);
                  file1 = repoData.incoming_loc + Titanium.Filesystem.getSeparator() + diffSet.path;
                  file2 = window.p2pdoc_settings.reviewed_dir(repoName) + Titanium.Filesystem.getSeparator() + diffSet.target_path_previous_version;
                  addedDiff.find("#changeView a").attr("href", "changes.html?file1=" + file1 + "&file2=" + file2).show();
                } else {
                  // it's something other than a file
                  addedDiff.find("#strangeView a").show();
                }
              }
            }
            if (diffSet.contents != null) {
              // show the count
              numFiles = diffSet.contents.length + " " + (diffSet.contents.length == 1 ? "file" : "files");
              addedDiff.find("#diffCount_").attr("id", "diffCount_" + diffNum).html(numFiles);
              // show a link to open in the browser
              repoData = window.p2pdoc_settings.get_repo_by_name(repoName);
              addedDiff.find("#sourceView a").html("(open file browser)").click(viewFileWrapperFunc(repoData.incoming_loc, diffSet.path)).show();
              // populate the contents
              var fileList = "";
              for (var fileNum = 0, fileCount = diffSet.contents.length; fileNum < fileCount; fileNum++) {
                fileList += "<li>" + diffSet.contents[fileNum] + "</li>\n";
              }
              addedDiff.find("#showContents a").after("<ul>" + fileList + "</ul>");
              addedDiff.find("#showContents a").next().hide();
              // add a toggling function
              addedDiff.find("#showContents a").click(function() {
                $(this).next().toggle(500);
                return false;
              }).show();
            }
          }
        }
      }
  
      // click to toggle panel
      $('.panelHeader').click(function() {
        $(this).next().toggle(500);
        return false;
      }).next().hide();
      
      // from http://jqueryfordesigners.com/fixed-floating-elements/
      var top = $('#sideAction').offset().top - parseFloat($('#sideAction').css('margin-top').replace(/auto/, 0));
      $(window).scroll(function (event) {
        // what the y position of the scroll is
        var y = $(this).scrollTop();
        
        // whether that's below the form
        if (y >= top) {
          // if so, ad the fixed class
          $('#sideAction').addClass('fixed');
        } else {
          // otherwise remove it
          $('#sideAction').removeClass('fixed');
        }
      });
    }

  } catch (e) {
    alert('error: ' + e);
  }

});
</script>
</head>
<body>

  <div style="float:right;">
    <a href="search.html"><img src="images/binoculars.32.png" alt="Search"/></a>
    <a href="repo-index.html"><img src="images/rss-feed.32.png" alt="Review Feeds"/></a>
    <a href="repositories.html"><img src="images/gear.32.png" alt="Configure"/></a>
  </div>

<h2 id="noRepos" class="ui-widget">Your first task is to find your incoming files.<br/>Click 'Configure' to tell me where they are.</h2>
<h2 id="noDiffs" class="ui-widget" style="display:none;">You've seen it all, so you can go play with another toy.<br/>Y'all come back now, ya hear?</h2>

<br/>
<br/>
<div id="outChanges" style="display:none;">
  <h3><a href="#" id="exportOutChanges"><span class="ui-widget">Export unshared changes to the outgoing folders.</span></a></h3>
  <span id="previewOutgoing">(preview)</span>
  <div id="outChangeList" style="display:none;">
  </div>
</div>

<div id="inChanges">
  <div id="repoList" class="ui-widget">
    <div id="repo_" style="display:none;">
      <h3 class="panelHeader">
        <a href="#">
          <span id="repoName_">repo</span>
          <span id="repoDiffCount_">count</span>
        </a>
      </h3>
      <div id="diffList">
        <div id="diff_" style="display:none;">
          <input type="checkbox" id="reviewed_" repo="_" path="_" previousPath="_">
          <span id="diffPath_">path</span>
          <span id="sourceView"><a href="#" style="display:none;">(open)</a></span>
          <span id="changeView"><a href="#" style="display:none;">(see changes)</a></span>
          <span id="strangeView"><a href="#" style="display:none;" onClick="javascript: alert('The source is an object of a different type, so something very strange happened to this thing.');">(strange)</a></span>
          <span id="showContents"><a href="#" style="display:none;">(list <span id="diffCount_">count</span>)</a></span>
        </div>
      </div>
    </div>
  </div>
  
  <div id="sideActionWrapper" class="ui-widget" style="display:none;">
    <div id="sideAction">
      <a href="#" onclick="javascript: markAccepted(); return false;">Accept</a>
    </div>
  </div>

</div>

</body>
</html>
