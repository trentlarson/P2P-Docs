<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title>P2P Docs</title>

<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>
<script type="text/javascript" src="js/stacktrace.js"></script>
<script type="text/javascript" src="js/p2pdocs.js"></script>

<link rel="stylesheet" type="text/css" href="css/smoothness/jquery-ui-1.8.13.custom.css"/>
<link rel="stylesheet" type="text/css" href="css/p2pdocs.css" />

<style>
#inChanges {
  position: relative;
}

#repoList {
  float: left;
  width: 500px;
}

#sideActionWrapper { /* required to avoid jumping */
  left: 500px;
  position: absolute;
  margin-left: 35px;
  width: 280px;
}

#sideAction {
  position: absolute;
  top: 0;
  padding-top: 30px;
}

#sideAction.fixed {
  position: fixed;
  top: 0;
}
</style>

<script type="text/ruby"       src="ruby/settings.rb"></script>
<script type="text/ruby"       src="ruby/updates.rb"></script>
<script type="text/ruby"       src="ruby/p2pdocs_utils.rb"></script>

<script type="text/javascript">
  var appPropsStr = Titanium.App.Properties.getString("appPropsJson");
  var appProps = JSON.parse(appPropsStr);
  window.settingsDir = appProps['settings-dir'];
</script>

<script type="text/ruby">
  window.p2pdoc_settings = Settings.new(window.settingsDir)
  window.p2pdoc_mark_reviewed = lambda { |repo_id, path, previous_path| Updates.mark_reviewed(window.p2pdoc_settings, repo_id, path, previous_path) }
  window.p2pdoc_mark_reviewed2 = lambda { |repo_id, path, previous_path| Titanium.API.print("got into method\n") }
  def p2pdoc_mark_reviewed3(repo_id, path, previous_path)
    Titanium.API.print("got into method #{repo_id} #{path} #{previous_path}.\n")
  end
</script>

<script type="text/javascript">

//Titanium.UI.getWindows()[0].showInspector()
//Titanium.API.print("to console\n");

function initializeChangeSummary() {
  if (typeof appProps['post-param'] != "undefined") {
    var actionData = appProps['post-param'];
    if (actionData != null) {
      //eg. {'action':'markReviewedBulk', 'reviewed':[{'id':0, 'name':'Bohemia', 'path':'Tao', 'previousPath':'Hedonism'}]}];
      if (actionData.action === 'markReviewedBulk') {
        var fileInfo;
        for (var i = actionData.reviewed.length - 1; i >= 0; i--) {
          fileInfo = actionData.reviewed[i];
          window.p2pdoc_mark_reviewed(fileInfo.id, fileInfo.path, fileInfo.previousPath);
        }
      }
      appProps['post-param'] = null;
      Titanium.App.Properties.setString('appPropsJson', JSON.stringify(appProps));
    }
  }
}

try {
  // calling a named method so there's something in the stack trace
  initializeChangeSummary();
} catch (e) {
  p2pdocsHandleError(e);
}

</script>




<script type="text/ruby">
  window.p2pdoc_all_diffs_json = P2PDocsUtils.strings_arrays_hashes_json(Updates.all_repo_diffs(window.p2pdoc_settings))
  window.p2pdoc_all_out_diffs_json = P2PDocsUtils.strings_arrays_hashes_json(Updates.all_outgoing_diffs(window.p2pdoc_settings))
  def copy_to_outgoing(out_diffs)
    out_diffs.each { |name_diff|
      name_diff.diffs.each { |diff|
        Updates.copy_to_outgoing(window.p2pdoc_settings, name_diff.repoId, diff.path)
      }
    }
  end
  window.copy_to_outgoing2 = lambda { |all_diffs| all_diffs.each { |name_diff| Updates.copy_all_to_outgoing(window.p2pdoc_settings, name_diff.repoId, name_diff.diffs) } }
</script>

<script type="text/javascript">

var Ti = {fs: Titanium.Filesystem, api:Titanium.API};

function setupMarkAction(reviewedList) {
  //eg. {'action':'markReviewedBulk', 'reviewed':[{'id':0, 'name':'Bohemia', 'path':'Tao', 'previousPath':'Hedonism'}]}];
  var actionData = {'action':'markReviewedBulk', 'reviewed':reviewedList};
  appProps['post-param'] = actionData;
  Titanium.App.Properties.setString('appPropsJson', JSON.stringify(appProps));
}

function getRepoById(allRepos, repoId) {
  for (var i = 0, len = allRepos.length; i < len; i++) {
    if (allRepos[i].id === repoId) {
      return allRepos[i];
    }
  }
  return null;
}

function markAccepted() {
  var checkedBoxes = $('input[type="checkbox"]:checked');
  if (checkedBoxes.length == 0) {
    alert("If you really want to accept something, you'll have to select it first.");
  } else {
    
    // gather the data for their reviewed choices (which I'd love to do inline, but the app often breaks when calling Ruby when it's not the initial page load)
    var reviewedList = [];
    checkedBoxes.each(function() {
      var repoId = parseInt($(this).attr("repoId"));
      var repoName = $(this).attr("repoName");
      var path = $(this).attr("path");
      var previousPath = $(this).attr("previousPath");
      reviewedList.push({'id':repoId, 'name':repoName, 'path':path, 'previousPath':previousPath});
    });
    setupMarkAction(reviewedList);
    
    // now smoothly adjust the display according to their choices
    var count = checkedBoxes.length;
    checkedBoxes.each(function(boxNum) {
      var repoName = $(this).attr("repoName");
      var path = $(this).attr("path");
      var previousPath = $(this).attr("previousPath");
      var repoDiv = $(this).parent().parent().parent();
      $(this).parent().hide(500, function() {
        $(this).remove();
        // now hide the repo if that was the last child
        if (repoDiv.find('#diffList').children().length == 1) {
          repoDiv.hide(500, function() {
            repoDiv.remove();
            // now revert to default display if that was the last repo
            if ($('#inChanges #repoList').children().length == 1) {
              $('#inChanges').hide(500);
              $('#noDiffs').show(500, function() {
                if (--count === 0) { window.location.href = "change-summary.html"; } // and refresh if this was the last step
              });
            } else {
              if (--count === 0) { window.location.href = "change-summary.html"; } // and refresh if this was the last step
            }
          });
        } else {
          if (--count === 0) { window.location.href = "change-summary.html"; } // and refresh if this was the last step
        }
      });
    });

  }
}

$(document).ready(function() {
  
  var errorDetails = {};
  try {
    
    var allRepos = window.p2pdoc_settings.properties().repositories;
    if (allRepos.length > 0) {
      $('#noRepos').hide();
      
      // show the copy-to-outgoing action
      var errorDetails = window.p2pdoc_all_out_diffs_json;
      var allOutDiffs = JSON.parse(window.p2pdoc_all_out_diffs_json);
      var errorDetails = {};
      
      var changesExist = false;
      if (allOutDiffs.length > 0) {
        changesExist = true;
        var outCount = allOutDiffs.length;
        for (var outRepoNum = 0; outRepoNum < outCount; outRepoNum++) {
          $('#outChangeList').append("<h4>" + allOutDiffs[outRepoNum].name + "</h4>");
          $('#outChangeList').append("<ul>\n");
          var outChangeCount = allOutDiffs[outRepoNum].diffs.length;
          for (var outChangeNum = 0; outChangeNum < outChangeCount; outChangeNum++) {
            $('#outChangeList').append("<li>" + allOutDiffs[outRepoNum].diffs[outChangeNum].path + "</li>\n");
          }
          $('#outChangeList').append("</ul>\n");
        }
        $('#exportOutChanges').click(function() {
            // This unfortunate necessity is because I cannot grab a simple "id" when calling Ruby (because it's deprecated and now called "object_id"), and I cannot figure out how to dig into Kroll and grab the 'id' field.
            allOutDiffsForRuby = []
            for (var index = allOutDiffs.length - 1; index >= 0; index--) {
              outDiff = allOutDiffs[index];
              allOutDiffsForRuby.push({'repoId':outDiff.id, 'name':outDiff.name, 'diffs':outDiff.diffs})
            }
            copy_to_outgoing(allOutDiffsForRuby);
            $('#outChanges').hide(500);
            return false;
        });
        $('#previewOutgoing').click(function() {
          $("#outChangeList").toggle(500);
        });
        $('#outChanges').show();
      }
      
      // show the incoming-review action
      var all_diffs = JSON.parse(window.p2pdoc_all_diffs_json);
      if (all_diffs.length == 0) {
        $('#noDiffs').show();
        
      } else {
        changesExist = true;
        $('#inChanges').show();
  
        // declare the repo variables for data and DOM elements
        var repoCount, repoTemplate, oneRepoDiffs, repoName, repoDiffList, repoDiffCount, addedRepo;
        var repoData, numChanges;
        // declare the diff variables for data and DOM elements
        var diffSet;
        var diffTemplate, addedDiff, numFiles;
        // gather info for checking for info in the tree-of-interest
        var interestCheckData = [];
        
        repoCount = all_diffs.length;
        repoTemplate = $('#inChanges #repoList #repo_');
        
        for (var repoNum = 0; repoNum < repoCount; repoNum++) {
          oneRepoDiffs = all_diffs[repoNum];
          repoId = parseInt(oneRepoDiffs.id);
          repoName = oneRepoDiffs.name;
          repoDiffList = oneRepoDiffs.diffs;
          repoDiffCount = repoDiffList.length;
          repoData = getRepoById(allRepos, repoId);
          
          addedRepo = repoTemplate.clone();
          addedRepo.insertBefore(repoTemplate);
          addedRepo.show();
          addedRepo.attr("id", "repo_" + repoNum);
          addedRepo.find("#repoName_").attr("id", "repoName_" + repoNum).html(repoName);
          numChanges = repoDiffCount + " " + (repoDiffCount == 1 ? "change" : "changes");
          addedRepo.find("#repoDiffCount_").attr("id", "repoDiffCount_" + repoNum).html("(" + numChanges + ")");
          
          diffTemplate = addedRepo.find('#diff_');
          
          for (var diffNum = 0; diffNum < repoDiffCount; diffNum++) {
            diffSet = repoDiffList[diffNum];
            interestCheckData.push({"path":repoData.incoming_loc + Titanium.Filesystem.getSeparator() + diffSet.path, "repoNum":repoNum, "diffNum":diffNum});
            
            addedDiff = diffTemplate.clone();
            addedDiff.insertBefore(diffTemplate);
            addedDiff.show();
            addedDiff.attr("id", "diff_" + diffNum);
            addedDiff.find("#reviewed_").attr("id", "reviewed_" + diffNum)
              .attr("repoId", repoId)
              .attr("repoName", repoName)
              .attr("path", diffSet.path)
              .attr("previousPath", diffSet.target_path_previous_version);
            
            addedDiff.find("#diffPath_").attr("id", "diffPath_" + diffNum).html(diffSet.path);
            if (diffSet.source_type == null) {
              addedDiff.find("#removed").show();
              
            } else if (diffSet.source_type === "file") {
              if (diffSet.target_type == null) {
                addedDiff.find("#sourceView a").click(viewFileWrapperFunc(repoData.incoming_loc, diffSet.path)).show();
              } else {
                // there's another file or something that's been reviewed
                if (diffSet.target_type === "file") {
                  file1 = repoData.incoming_loc + Titanium.Filesystem.getSeparator() + diffSet.path;
                  file2 = window.p2pdoc_settings.reviewed_dir(repoData) + Titanium.Filesystem.getSeparator() + diffSet.target_path_previous_version;
                  addedDiff.find("#changeView a").attr("href", "file-diff.html?file1=" + file1 + "&file2=" + file2).show();
                } else {
                  // it's something other than a file
                  addedDiff.find("#strangeView a").show();
                }
              }
              
            } else if (diffSet.source_type === "directory"
                       && diffSet.contents != null) {
              // show the count
              numFiles = diffSet.contents.length + " " + (diffSet.contents.length == 1 ? "file" : "files");
              addedDiff.find("#diffCount_").attr("id", "diffCount_" + diffNum).html(numFiles);
              // show a link to open in the browser
              addedDiff.find("#sourceView a").html("(open file browser)").click(viewFileWrapperFunc(repoData.incoming_loc, diffSet.path)).show();
              // populate the contents
              var fileList = "";
              for (var fileNum = 0, fileCount = diffSet.contents.length; fileNum < fileCount; fileNum++) {
                fileList += "<li>" + diffSet.contents[fileNum] + "</li>\n";
              }
              addedDiff.find("#showContents a").after("<ul>" + fileList + "</ul>");
              addedDiff.find("#showContents a").next().hide();
              // add a toggling function
              addedDiff.find("#showContents a").click(function() {
                $(this).next().toggle(500);
                return false;
              }).show();
            }
          }
        }
      }

      if (urlParam("redirectIfNoUpdates") != null
          && !changesExist) {
        window.location.href = "search.html";
      }
    
      // click to toggle panel
      $('.panelHeader').click(function() {
        $(this).next().toggle(500);
        return false;
      }).next().hide();
      
      // from http://jqueryfordesigners.com/fixed-floating-elements/
      var top = $('#sideAction').offset().top - parseFloat($('#sideAction').css('margin-top').replace(/auto/, 0));
      $(window).scroll(function (event) {
        // what the y position of the scroll is
        var y = $(this).scrollTop();
        
        // whether that's below the form
        if (y >= top) {
          // if so, ad the fixed class
          $('#sideAction').addClass('fixed');
        } else {
          // otherwise remove it
          $('#sideAction').removeClass('fixed');
        }
      });
    }

  } catch (e) {
    p2pdocsHandleError(e, errorDetails);
  }

});
</script>
</head>



<body>

  <div style="float:right;">
    <a href="search.html"><img src="images/binoculars.32.png" alt="Search"/></a>
    <a href="change-summary.html"><img src="images/rss-feed.32.png" alt="Review Feeds"/></a>
    <a href="repositories.html"><img src="images/gear.32.png" alt="Configure"/></a>
  </div>

<h2 id="noRepos">Your first task is to find your incoming files.<br/>Click 'Configure' to tell me where they are.</h2>
<h2 id="noDiffs" style="display:none;">You've seen it all, so you can go play with another toy.<br/>Y'all come back now, ya hear?</h2>

<br/>
<br/>
<div id="outChanges" style="display:none;">
  <span><strong>You've made changes that aren't exported to the outgoing folders.</strong></span>
  <a href="#" id="previewOutgoing">(preview)</a>
  <a href="#" id="exportOutChanges">(export)</a>
  <br/>
  <br/>
  <div id="outChangeList" style="display:none;"></div>
</div>

<br/>
<br/>
<div id="inChanges" style="display:none;">
  <span><strong>Here are incoming changes that you haven't reviewed.</strong></span>
  <br/>
  <div id="repoList">
    <div id="repo_" style="display:none;">
      <h3 class="panelHeader">
        <a href="#">
          <span id="repoName_">repo</span>
          <span id="repoDiffCount_">count</span>
        </a>
      </h3>
      <div id="diffList">
        <div id="diff_" style="display:none;">
          <input type="checkbox" id="reviewed_" repoId="_" repoName="_" path="_" previousPath="_">
          <span id="diffPath_">path</span>
          <span id="removed" style="display:none;">(removed)</span>
          <span id="sourceView"><a href="#" style="display:none;">(open)</a></span>
          <span id="changeView"><a href="#" style="display:none;">(see changes)</a></span>
          <span id="strangeView"><a href="#" style="display:none;" onClick="javascript: alert('The source is an object of a different type, so something very strange happened to this thing.');">(strange)</a></span>
          <span id="showContents"><a href="#" style="display:none;">(list <span id="diffCount_">count</span>)</a></span>
        </div>
      </div>
    </div>
  </div>
  
  <div id="sideActionWrapper">
    <div id="sideAction">
      <a href="#" onclick="javascript: markAccepted(); return false;">Accept Checked</a>
    </div>
  </div>

</div>

</body>
</html>
