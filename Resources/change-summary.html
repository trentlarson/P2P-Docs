<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title>P2P Docs</title>

<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>
<script type="text/javascript" src="js/jquery.flowplayer.org.tools.min.js"></script>
<script type="text/javascript" src="js/stacktrace.js"></script>
<script type="text/javascript" src="js/p2pdocs.js"></script>

<link rel="stylesheet" type="text/css" href="css/smoothness/jquery-ui-1.8.13.custom.css"/>
<link rel="stylesheet" type="text/css" href="css/p2pdocs.css" />

<style>

#repoList {
  float: left;
  width: 500px;
}

#sideActionWrapper { /* required to avoid jumping */
  left: 500px;
  position: absolute;
  margin-left: 35px;
  width: 280px;
}

#sideAction {
  position: absolute;
  top: 0;
  padding-top: 30px;
}

#sideAction.fixed {
  position: fixed;
  top: 0;
}

.tooltip {
  display:none;
  background:transparent url(images/box_white_small.png);
  font-size:12px;
  width:80px;
  height:30px;
  padding:12px;
  color:#000; 
}
</style>

<script type="text/ruby"       src="ruby/settings.rb"></script>
<script type="text/ruby"       src="ruby/updates.rb"></script>
<script type="text/ruby"       src="ruby/p2pdocs_utils.rb"></script>

<script type="text/javascript">
  var appPropsStr = Ti.App.Properties.getString("appPropsJson");
  var appProps = JSON.parse(appPropsStr);
  window.settingsDir = appProps['settings-dir'];
</script>

<script type="text/ruby">
  window.p2pdoc_settings = Settings.new(window.settingsDir)
  window.p2pdoc_reviewed_dir = window.p2pdoc_settings.reviewed_dir;
  window.p2pdoc_mark_reviewed = lambda { |repo_id, path, previous_path| Updates.mark_reviewed(window.p2pdoc_settings, repo_id, path, previous_path) }
  window.p2pdoc_mark_reviewed2 = lambda { |repo_id, path, previous_path| Ti.API.print("got into method\n") }
  def p2pdoc_mark_reviewed3(repo_id, path, previous_path)
    Ti.API.print("got into method #{repo_id} #{path} #{previous_path}.\n")
  end
</script>

<script type="text/javascript">

//Ti.UI.getWindows()[0].showInspector()
//Ti.API.print("to console\n");

function initializeChangeSummary() {
 try {

  if (typeof appProps['post-param'] != "undefined") {
    var actionData = appProps['post-param'];
    if (actionData != null) {
      //eg. {'action':'markReviewedBulk', 'reviewed':[{'id':0, 'name':'Bohemia', 'path':'Tao', 'previousPath':'Hedonism'}]}];
      if (actionData.action === 'markReviewedBulk') {
        var fileInfo;
        for (var i = actionData.reviewed.length - 1; i >= 0; i--) {
          fileInfo = actionData.reviewed[i];
          window.p2pdoc_mark_reviewed(fileInfo.repoId, fileInfo.path, fileInfo.previousPath);
        }
      }
      appProps['post-param'] = null;
      Ti.App.Properties.setString('appPropsJson', JSON.stringify(appProps));
    }
  }

 } catch (e) {
  p2pdocsHandleError(e);
 }
}
// using a function name to show in stack traces in error handling
initializeChangeSummary();

</script>




<script type="text/ruby">
  window.p2pdoc_all_diffs_json = P2PDocsUtils.strings_arrays_hashes_json(Updates.all_repo_diffs(window.p2pdoc_settings))
  window.p2pdoc_all_out_diffs_json = P2PDocsUtils.strings_arrays_hashes_json(Updates.all_outgoing_diffs(window.p2pdoc_settings))
  def copy_to_outgoing(out_diffs)
    out_diffs.each { |name_diff|
      name_diff.diffs.each { |diff|
        Updates.copy_to_outgoing(window.p2pdoc_settings, name_diff.repoId, diff.path)
      }
    }
  end
  window.copy_to_outgoing2 = lambda { |all_diffs| all_diffs.each { |name_diff| Updates.copy_all_to_outgoing(window.p2pdoc_settings, name_diff.repoId, name_diff.diffs) } }
</script>

<script type="text/javascript">

/* Set up a back-end action to do on reload, since we have all kinds of problems trying to run Ruby after the page has loaded. */
function setupMarkAction(reviewedList) {
  //eg. {'action':'markReviewedBulk', 'reviewed':[{'id':0, 'name':'Bohemia', 'path':'Tao', 'previousPath':'Hedonism'}]}];
  var actionData = {'action':'markReviewedBulk', 'reviewed':reviewedList};
  appProps['post-param'] = actionData;
  Ti.App.Properties.setString('appPropsJson', JSON.stringify(appProps));
}

function getRepoById(allRepos, repoId) {
  for (var i = 0, len = allRepos.length; i < len; i++) {
    if (allRepos[i].id === repoId) {
      return allRepos[i];
    }
  }
  return null;
}
// repoId is the ID of the repository
// Note that this is a duplicate of a part of Ruby Settings.reviewed_dir(repoId)
function getReviewedDir(repoId) {
  return window.p2pdoc_reviewed_dir + Ti.Filesystem.getSeparator() + repoId;
}

function markOutAccepted() {
  var checkedBoxes = $('#inChanges input[type="checkbox"]:checked');
  if (checkedBoxes.length == 0) {
    alert("If you really want to publish something, you'll have to select it first.");
  } else {
    alert("Not implemented.");
  }
}

function markInAccepted() {
  var checkedBoxes = $('#inChanges input[type="checkbox"]:checked').not("#checkAll");
  if (checkedBoxes.length == 0) {
    alert("If you really want to accept something, you'll have to select it first.");
  } else {
    
    // gather the data for their reviewed choices (which I'd love to do inline, but the app often breaks when calling Ruby when it's not the initial page load)
    var reviewedList = [];
    checkedBoxes.each(function() {
      var repoId = parseInt($(this).attr("repoId"));
      var repoName = $(this).attr("repoName");
      var path = $(this).attr("path");
      var previousPath = $(this).attr("previousPath");
      reviewedList.push({'repoId':repoId, 'name':repoName, 'path':path, 'previousPath':previousPath});
    });
    setupMarkAction(reviewedList);
    
    // now smoothly adjust the display according to their choices
    var count = checkedBoxes.length;
    checkedBoxes.each(function(boxNum) {
      var repoName = $(this).attr("repoName");
      var path = $(this).attr("path");
      var previousPath = $(this).attr("previousPath");
      var repoDiv = $(this).parent().parent().parent();
      $(this).parent().hide(500, function() {
        $(this).remove();
        // now hide the repo if that was the last child
        if (repoDiv.find('#diffList').children().length == 1) {
          repoDiv.hide(500, function() {
            repoDiv.remove();
            // now revert to default display if that was the last repo
            if ($('#inChanges #repoList').children().length == 1) {
              $('#inChanges').hide(500);
              $('#noDiffs').show(500, function() {
                if (--count === 0) { window.location.href = "change-summary.html"; } // and refresh if this was the last step
              });
            } else {
              if (--count === 0) { window.location.href = "change-summary.html"; } // and refresh if this was the last step
            }
          });
        } else {
          if (--count === 0) { window.location.href = "change-summary.html"; } // and refresh if this was the last step
        }
      });
    });

  }
}

function initializeDisplay() {

  var errorDetails = {};
  try {
    
    $("#search[title]").tooltip({ position:"bottom left", effect:"slide" });
    $("#reviewFeeds[title]").tooltip({ position:"bottom left", effect:"slide" });
    $("#configure[title]").tooltip({ position:"bottom left", effect:"slide" });

    var repoData;
    var allRepos = window.p2pdoc_settings.properties().repositories;
    if (allRepos.length > 0) {
      $('#noRepos').hide();
      
      // show the copy-to-outgoing action
      var errorDetails = window.p2pdoc_all_out_diffs_json;
      var allOutDiffs = JSON.parse(window.p2pdoc_all_out_diffs_json);
      var errorDetails = {};
      
      var repoTemplate, repoId, repoName, addedRepo;
      var diffTemplate, addedDiff;
      if (allOutDiffs.length > 0) {
        $('#outChanges').show();
        
        var outCount = allOutDiffs.length;
        repoTemplate = $('#outChanges #repoList #repo_');
        
        for (var outRepoNum = 0; outRepoNum < outCount; outRepoNum++) {
          oneRepoDiffs = allOutDiffs[outRepoNum];
          repoName = oneRepoDiffs.name;
          
          addedRepo = repoTemplate.clone();
          addedRepo.insertBefore(repoTemplate);
          addedRepo.show();
          addedRepo.attr("id", "repo_" + outRepoNum);
          addedRepo.find("#repoName_").attr("id", "repoName_" + outRepoNum).html(allOutDiffs[outRepoNum].name);

          diffTemplate = addedRepo.find('#diff_');
          
          var outChangeCount = allOutDiffs[outRepoNum].diffs.length;
          var outDiff, outPath;
          for (var outChangeNum = 0; outChangeNum < outChangeCount; outChangeNum++) {
            addedDiff = diffTemplate.clone();
            addedDiff.insertBefore(diffTemplate);
            addedDiff.show();
            addedDiff.attr("id", "diff_" + outChangeNum);
            
            outDiff = allOutDiffs[outRepoNum].diffs[outChangeNum];
            outPath = outDiff.path;
            if (outDiff.target_path_next_version != outDiff.path) {
              outPath += " ( -> " + outDiff.target_path_next_version + ")";
            }
            addedDiff.find("#diffPath_").attr("id", "diffPath_" + outChangeNum).html(outPath);
          }
        }
        $('#exportOutChanges').click(function() {
            // This unfortunate necessity is because I cannot grab a simple "id" when calling Ruby (because it's deprecated and now called "object_id"), and I cannot figure out how to dig into Kroll and grab the 'id' field.
            allOutDiffsForRuby = []
            for (var index = allOutDiffs.length - 1; index >= 0; index--) {
              outDiff = allOutDiffs[index];
              allOutDiffsForRuby.push({'repoId':outDiff.id, 'name':outDiff.name, 'diffs':outDiff.diffs})
            }
            copy_to_outgoing(allOutDiffsForRuby);
            $('#outChanges').hide(500);
            return false;
        });
        $('#previewOutgoing').click(function() {
          $("#outChanges #repoList").toggle(500);
        });
      }
      
      // show the incoming-review action
      var all_diffs = JSON.parse(window.p2pdoc_all_diffs_json);
      if (all_diffs.length == 0) {
        $('#noDiffs').show();
        
      } else {
        $('#inChanges').show();
  
        // declare the repo variables for data and DOM elements
        var repoCount, oneRepoDiffs, repoDiffList, repoDiffCount;
        var numChanges;
        // declare the diff variables for data and DOM elements
        var diffSet;
        var numFiles;
        // gather info for checking for info in the tree-of-interest
        var interestCheckData = [];
        
        repoCount = all_diffs.length;
        repoTemplate = $('#inChanges #repoList #repo_');
        
        // another hack, because I found the reference to reviewed_dir later would be undefined unless I reference it here, outside the 'for' statement
        // ... but now that I'm setting this in a variable in the Ruby script section, we may be OK
        //var junk = " " + window.p2pdoc_settings.reviewed_dir;

        for (var repoNum = 0; repoNum < repoCount; repoNum++) {
          oneRepoDiffs = all_diffs[repoNum];
          repoId = parseInt(oneRepoDiffs.id);
          repoName = oneRepoDiffs.name;
          repoDiffList = oneRepoDiffs.diffs;
          repoDiffCount = repoDiffList.length;
          repoData = getRepoById(allRepos, repoId);
          
          addedRepo = repoTemplate.clone();
          addedRepo.insertBefore(repoTemplate);
          addedRepo.show();
          addedRepo.attr("id", "repo_" + repoNum);
          addedRepo.find("#repoName_").attr("id", "repoName_" + repoNum).html(repoName);
          numChanges = repoDiffCount + " " + (repoDiffCount == 1 ? "change" : "changes");
          addedRepo.find("#repoDiffCount_").attr("id", "repoDiffCount_" + repoNum).html("(" + numChanges + ")");
          addedRepo.find('#checkAll').click(function() {
            var newValue = $(this).attr("checked");
            $(this).parent().find('div input[type="checkbox"]').not("#reviewed_").each(function() {
              $(this).attr("checked", newValue);
            });
          });
          
          diffTemplate = addedRepo.find('#diff_');
          
          for (var diffNum = 0; diffNum < repoDiffCount; diffNum++) {
            diffSet = repoDiffList[diffNum];
            interestCheckData.push({"path":repoData.incoming_loc + Ti.Filesystem.getSeparator() + diffSet.path, "repoNum":repoNum, "diffNum":diffNum});
            
            addedDiff = diffTemplate.clone();
            addedDiff.insertBefore(diffTemplate);
            addedDiff.show();
            addedDiff.attr("id", "diff_" + diffNum);
            addedDiff.find("#reviewed_").attr("id", "reviewed_" + diffNum)
              .attr("repoId", repoId)
              .attr("repoName", repoName)
              .attr("path", diffSet.path)
              .attr("previousPath", diffSet.target_path_previous_version);
            
            addedDiff.find("#diffPath_").attr("id", "diffPath_" + diffNum).html(diffSet.path);
            if (diffSet.source_type == null) {
              addedDiff.find("#removed").show();
              
            } else if (diffSet.source_type === "file") {

              if (diffSet.target_type == null) {
                addedDiff.find("#sourceView a").click(viewFileWrapperFunc(repoData.incoming_loc, diffSet.path)).show();
              } else {
                // there's another file or something that's been reviewed
                if (diffSet.target_type === "file") {
                  file1 = repoData.incoming_loc + Ti.Filesystem.getSeparator() + diffSet.path;
                  file2 = getReviewedDir(repoId) + Ti.Filesystem.getSeparator() + diffSet.target_path_previous_version;
                  addedDiff.find("#changeView a").attr("href", "file-diff.html?file1=" + file1 + "&file2=" + file2).show();
                } else {
                  // it's something other than a file
                  addedDiff.find("#strangeView a").show();
                }
              }
              
            } else if (diffSet.source_type === "directory"
                       && diffSet.contents != null) {
              // show the count
              numFiles = diffSet.contents.length + " " + (diffSet.contents.length == 1 ? "file" : "files");
              addedDiff.find("#diffCount_").attr("id", "diffCount_" + diffNum).html(numFiles);
              // show a link to open in the browser
              addedDiff.find("#sourceView a").html("(open file browser)").click(viewFileWrapperFunc(repoData.incoming_loc, diffSet.path)).show();
              // populate the contents
              var fileList = "";
              for (var fileNum = 0, fileCount = diffSet.contents.length; fileNum < fileCount; fileNum++) {
                fileList += "<li>" + diffSet.contents[fileNum] + "</li>\n";
              }
              addedDiff.find("#showContents a").after("<ul>" + fileList + "</ul>");
              addedDiff.find("#showContents a").next().hide();
              // add a toggling function
              addedDiff.find("#showContents a").click(function() {
                $(this).next().toggle(500);
                return false;
              }).show();
            }
          }
        }
        
        // consider removing the template HTML (so that select-all functions don't give problems, eg. checkAll checkboxes)
        
        
        // fire off a check for any info from the tree-of-interest
        if (appProps['ancestryIds']) {
          var idData = appProps['ancestryIds']
          $.post('http://127.0.0.1:1338/check_database', {'ancestryIds':JSON.stringify(idData), "incomingFiles":JSON.stringify(interestCheckData)}, function(data) {
            $('#incomingSearchProgress').hide();
            //Ti.API.print("Got something from database: " + data + "\n");
            var interestingData = JSON.parse(data);
            var oneFile;
            if (interestingData.length > 0) {
              $('#incomingSearchDone').show(1000);
              for (var i = 0, len = interestingData.length; i < len; i++) {
                oneFile = interestingData[i];
                $('#inChanges #repo_' + oneFile.repoNum + ' #diffPath_' + oneFile.diffNum).before("<img src='images/button-green-solid.16.png'>");
              }
            }
          }).error(function(error){p2pdocsHandleError(error, {"sqliteFile":Ti.App.Properties.getString("genealogy_db_path")});});
        } else { // there are no ancestryIds stored
          $('#incomingSearchProgress').hide();
        }
        
      }

      // click to toggle panel
      $('.panelHeader').click(function() {
        $(this).next().toggle(500);
        return false;
      }).next().hide();
      
      // from http://jqueryfordesigners.com/fixed-floating-elements/
      var top = $('#sideAction').offset().top - parseFloat($('#sideAction').css('margin-top').replace(/auto/, 0));
      $(window).scroll(function (event) {
        // what the y position of the scroll is
        var y = $(this).scrollTop();
        
        // whether that's below the form
        if (y >= top) {
          // if so, ad the fixed class
          $('#sideAction').addClass('fixed');
        } else {
          // otherwise remove it
          $('#sideAction').removeClass('fixed');
        }
      });
    }

  } catch (e) {
    p2pdocsHandleError(e, errorDetails);
  }
}

$(document).ready(function() {
  // calling a named method so there's something in the stack trace
  initializeDisplay();
});
</script>
</head>



<body>

  <div style="float:right;">
    <a href="search.html"><img src="images/binoculars.32.png" title="Search" id="search"/></a>
    <a href="change-summary.html"><img src="images/rss-feed.32.png" title="Review Feeds" id="reviewFeeds"/></a>
    <a href="repositories.html"><img src="images/gear.32.png" title="Configure" id="configure"/></a>
  </div>

<h2 id="noRepos">Your first task is to find your incoming files.<br/>Click 'Configure' (green gear) to tell me where they are.</h2>
<h2 id="noDiffs" style="display:none;">You've seen it all, so you can go play with another toy.<br/>Y'all come back now, ya hear?</h2>

<br/>
<br/>
<div id="outChanges" style="display:none; width:100%">
  <div>
    <h2>Outgoing</h2>
    <strong>You've made changes that aren't exported to the outgoing folders.</strong>
    <a href="#" id="previewOutgoing">(preview)</a>
    <a href="#" id="exportOutChanges">(export all)</a>
  </div>
  <br/>
  <br/>
  <div id="repoList" style="display:none;">
    <div id="repo_" style="display:none;">
      <h3><span id="repoName_">repo</span></h3>
      <div>
        <div id="diff_" style="display:none;">
          <span id="diffPath_"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="inChanges" style="display:none; clear:both;">
  
  <br/>
  <br/>
  <br/>
  
  <span><h2>Incoming</h2><strong>Here are incoming changes that you haven't reviewed.</strong></span>
  <br/>
  <span id="incomingSearchProgress">&nbsp;&nbsp;&nbsp;Searching for references in your tree-of-interest... <img src="images/anim-flower.gif"></span>
  <span id="incomingSearchDone" style="display:none;">&nbsp;&nbsp;&nbsp;<img src="images/button-green-solid.16.png"> - Files that contain info for you</span>
  <div id="repoList">
    <div id="repo_" style="display:none;">
      <h3 class="panelHeader">
        <a href="#">
          <span id="repoName_">repo</span>
          <span id="repoDiffCount_">count</span>
        </a>
      </h3>
      <div id="diffList">
        <input type="checkbox" id="checkAll">check/uncheck all
        <br/>
        <br/>
        <div id="diff_" style="display:none;">
          <input type="checkbox" id="reviewed_" repoId="_" repoName="_" path="_" previousPath="_">
          <span id="diffPath_">path</span>
          <span id="removed" style="display:none;">(removed)</span>
          <span id="sourceView"><a href="#" style="display:none;">(open)</a></span>
          <span id="changeView"><a href="#" style="display:none;">(see changes)</a></span>
          <span id="strangeView"><a href="#" style="display:none;" onClick="javascript: alert('The source is an object of a different type, so something very strange happened to this thing.');">(strange)</a></span>
          <span id="showContents"><a href="#" style="display:none;">(list <span id="diffCount_">count</span>)</a></span>
        </div>
      </div>
    </div>
  </div>
  
  <div id="sideActionWrapper">
    <div id="sideAction">
      <a href="#" onclick="javascript: markInAccepted(); return false;">Accept Checked</a>
    </div>
  </div>

</div>

</body>
</html>
