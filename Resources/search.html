<html>
<head>

<style type=text/css>

.blurb {
  height: 30px;
}

.openApp {
  cursor: pointer;
  color: #0000ff;
  text-decoration: underline;
}

</style>

<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
<script type="text/ruby"       src="ruby/search.rb"></script>

<script type="text/ruby">
  if (!Titanium.App.Properties.hasProperty('settings-dir'))
    Titanium.App.Properties.setString('settings-dir', Titanium.Filesystem.getApplicationDataDirectory().toString());
  end
</script>

<script type="text/ruby">
  window.searcher = Search.new
</script>

<script type="text/javascript">

var Ti = {fs: Titanium.Filesystem, api:Titanium.API};

function endsWith(str, suffix) {
  return str.indexOf(suffix, str.length - suffix.length) !== -1;
}

// http://www.netlobo.com/url_query_string_javascript.html
function getParam(name) {
  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  var regex = new RegExp( regexS );
  var results = regex.exec( window.location.href );
  if( results == null )
    return null;
  else
    return results[1];
}

function openFile(filename, filepos) {
  if (endsWith(filename, ".htm")
      || endsWith(filename, ".html")) {
    var anchorName = window.searcher.previous_anchor_name(filename, filepos);
    if (anchorName) {
      filename = filename + "#" + anchorName;
    } else {
      alert("There is no anchor point near that text.  The file will open at the top, and you'll have to search for that text.");
    }
    Titanium.Desktop.openURL("file://" + filename);
  } else {
    Titanium.Desktop.openApplication(filename);
  }
}
      
$(document).ready(function() {
  try {
    
    // First, open up a file if requested.
    var filename = getParam("filename"), filepos = getParam("filepos");
    if (filename != null) {
      openFile(filename, filepos);
    }
    
    $('#term').focus();

    var term = getParam("term");
    if (term != null) {
      
      if (term.length < 2) {
        alert("Sorry, I'm not going to even try for fear I'll choke on the massive set of data.");
      } else {
        var moreInfo = window.searcher.main("/Users/tlarson/backed/doc/family-histories/JeanGould.html", term);
        var nothing = moreInfo.toString(); // this is just to avoid crashes, eg. on searches for "Robert"
        //Titanium.API.print("results: " + moreInfo + "\n"); // this also could avoid crashes
        
        if (moreInfo.length == 0) {
          $("#files").append("Nothing.");
        } else {
          
          // create an element for each search result
          for (var i = 0; i < moreInfo.length; i++) {
            var file = moreInfo[i].file, pos = moreInfo[i].pos
            $("#files").append("<div class='blurb'><span class='openApp' file='" + moreInfo[i].file + "' pos='" + moreInfo[i].pos + "'>" + moreInfo[i].line + "</span></div>")
              .click(function(e) {
                window.location.href = "search.html?filename=" + encodeURI(file) + "&filepos=" + encodeURI(pos);
              });
              /** error in JavaScript: TypeError: Result of expression 'window.searcher.previous_anchor_name' [undefined] is not a function.
              .click(function(e) { openFile(file, pos); });
              **/
          }
          
          /** error when you click on it, in JavaScript: TypeError: Result of expression 'window.searcher.previous_anchor_name' [undefined] is not a function.
           *  ... or in Ruby if I finagle anything that calls Ruby (on method 'freeze' or 'public_methods' or...): Error: undefined method `call' for "freeze":String
          $(".blurb .openApp").each(function() {
            $(this).click(function(e) { openFile($(this).attr("file"), parseInt($(this).attr("pos"))); });
          });
          **/
        }
      }
    }

  } catch (e) {
    alert('error: ' + e);
  }

});

</script>

</head>
<body>

  <div>
    <form action="search.html">
      <input type="text" id="term" name="term" />
      <input type="submit" value="search"/>
    </form>
  </div>
  <div id="files"></div>
</body>
</html>
