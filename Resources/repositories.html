<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title>Repositories</title>

<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>

<link type="text/css" href="css/smoothness/jquery-ui-1.8.13.custom.css" rel="stylesheet"/>

<style type="text/css">
.repoRemove {
  display: none;
  cursor: pointer;
}
.repoInfo {
  cursor: pointer;
  vertical-align: 100%;
  display: none;
}
.repoAdd {
  cursor: pointer;
}
.repoAccept {
  visibility: hidden;
  cursor: pointer;
}
.repoRevert {
  visibility: hidden;
  cursor: pointer;
}
</style>

<script type="text/ruby" src="ruby/settings.rb"></script>
<script type="text/ruby">
  window.p2pdoc_settings = Settings.new(Titanium.Filesystem.getApplicationDataDirectory())
</script>

<script type="text/javascript">
var Ti = {fs: Titanium.Filesystem, api:Titanium.API};

//Titanium.UI.getWindows()[0].showInspector()
//Titanium.api.print("to console");

var remove_repo = function(name) {
  function remove_it() {
    if (confirm("This will stop tracking the repository " + name + ", but it will leave all the files.  Are you sure you want to stop tracking it?")) {
      window.p2pdoc_settings.remove_repo(name);
      window.p2pdoc_settings.save();
      
      var dom_suffix = window.p2pdoc_settings.fixed_repo_name(name);
      var selector = "#repoItem_" + dom_suffix;
      $(selector).hide(500, function() {
        $(this).remove()
      });
    }
  }
  return remove_it;
};

var change_repo_path = function(name) {
  return function(event) {
    window.p2pdoc_settings.change_repo_path(name, event.target.value);
    window.p2pdoc_settings.save();
  };
}

$(document).ready(function() {

try {

  var repos = window.p2pdoc_settings.properties().repositories;

  if (repos.length > 0) {
    var item = $('#repoItem_');
    var repo, dom_suffix, added_item;
    for (var i = 0; i < repos.length; i++) {
      repo = repos[i];
      dom_suffix = window.p2pdoc_settings.fixed_repo_name(repo.name);
      
      // create the visual for it
      addedItem = item.clone();
      addedItem.insertBefore(item);
      addedItem.attr("id", "repoItem_" + dom_suffix);
      addedItem.find("#repoRemove_").attr("id", "repoRemove_" + dom_suffix).show();
      addedItem.find("#repoName_")  .attr("id", "repoName_"   + dom_suffix).show().html(repo.name);
      addedItem.find("#repoPath_")  .attr("id", "repoPath_"   + dom_suffix).show().val(repo.source_dir).width(repo.source_dir.length * 8);
      addedItem.find("#repoAdd_")   .attr("id", "repoAdd_"    + dom_suffix).hide();
      addedItem.find("#repoAccept_").attr("id", "repoAccept_" + dom_suffix).hide();
      addedItem.find("#repoRevert_").attr("id", "repoRevert_" + dom_suffix).hide();
      
      // attach methods to the visuals
      addedItem.find("#repoRemove_" + dom_suffix).click(remove_repo(repo.name));
      addedItem.find("#repoPath_" + dom_suffix).change(change_repo_path(repo.name));
      
    }

  }

} catch (e) {
  alert('error: ' + e);
}

$('#repoItem_ #repoAdd_').bind('click', function() {
  
  $('#dialog-form').dialog({
    modal: true,
    buttons: {
      "Register": function() {
        var new_name = $('#dialog-form #name')[0].value;
        var dom_suffix = window.p2pdoc_settings.fixed_repo_name(new_name);
        var new_dir = Titanium.Filesystem.getApplicationDataDirectory() + "/" + dom_suffix;
        window.p2pdoc_settings.add_repo(new_name, new_dir);
        window.p2pdoc_settings.save();
        var item, added_item;
        
        // create the visual for it
        item = $('#repoItem_');
        addedItem = item.clone();
        addedItem.insertBefore(item).hide();
        addedItem.attr("id", "repoItem_" + dom_suffix).hide();
        addedItem.find("#repoRemove_").attr("id", "repoRemove_" + dom_suffix).show();
        addedItem.find("#repoName_")  .attr("id", "repoName_"   + dom_suffix).show().html(new_name);
        addedItem.find("#repoPath_")  .attr("id", "repoPath_"   + dom_suffix).show().val(new_dir).width(new_dir.length * 8);
        addedItem.find("#repoAdd_")   .attr("id", "repoAdd_"    + dom_suffix).hide();
        addedItem.find("#repoAccept_").attr("id", "repoAccept_" + dom_suffix).hide();
        addedItem.find("#repoRevert_").attr("id", "repoRevert_" + dom_suffix).hide();
        
        // attach methods to the visuals
        addedItem.find("#repoRemove_" + dom_suffix).click(remove_repo(new_name));
        addedItem.find("#repoPath_" + dom_suffix).change(change_repo_path(new_name));
        
        addedItem.toggle(500);
        $( this ).dialog( "close" );
      },
      "Cancel": function() {
        $( this ).dialog( "close" );
      }
    }
  });
});

});

</script>
</head>

<body>
<h1>Repositories</h1>

<a href="index.html">Index</a>

<div id="repoList">
  <div id="repoItem_" class="repoItem">
    <img src="images/button-red-x.png" title="Remove" alt="Remove" id="repoRemove_" class="repoRemove">
    <span id="repoName_" class="repoInfo"></span>
    <input type="text" name="path_" id="repoPath_" class="repoInfo">
    <img src="images/button-green-plus.png" title="Add" alt="Add" id="repoAdd_" class="repoAdd">
    <img src="images/button-green-check.png" title="Accept" alt="Accept" id="repoAccept_" class="repoAccept">
    <img src="images/button-red-back.png" title="Revert" alt="Revert" id="repoRevert_" class="repoRevert">
  </div>
</div>

<div id="dialog-form" title="Repository" style="display:none;">
  <form>
    <fieldset>
      <label>Label</label>
      <input type="text" id="name" name="name"/>
    </fieldset>
  </form>
</div>

</body>
</html>
