<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>

<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>
<script type="text/javascript" src="js/jquery.flowplayer.org.tools.min.js"></script>
<script type="text/javascript" src="js/knockout-1.2.1.js"></script>
<script type="text/javascript" src="js/knockout-nonhtml.js"></script>

<link type="text/css" href="css/smoothness/jquery-ui-1.8.13.custom.css" rel="stylesheet"/>

<style type="text/css">
.repoItem {
  display: none;
}
.repoRemove {
  cursor: pointer;
}
.repoInfo {
}
.repoAdd {
  cursor: pointer;
}
.repoAct {
  cursor: pointer;
  vertical-align: top;
}

.tooltip {
  display:none;
  background:transparent url(images/box_white.png);
  font-size:12px;
  width:160px;
  height:60px;
  padding:25px;
  color:#000; 
}
</style>

<script type="text/ruby" src="ruby/settings.rb"></script>
<script type="text/ruby">
  window.p2pdoc_settings = Settings.new(Titanium.App.Properties.getString("settings-dir"))
</script>

<script type="text/javascript">
var Ti = {fs: Titanium.Filesystem, api:Titanium.API};

//Titanium.UI.getWindows()[0].showInspector()
//Titanium.api.print("to console");

// render each repository
var insertRepo = function(repo, showSlowly) {
  
  var item = $('#repoItem_');
  var dom_suffix = repo.id;
  var addedItem = item.clone();
  addedItem.insertBefore(item);
  if (showSlowly) {
    addedItem.hide();
  } else {
    addedItem.show();
  }
  addedItem.attr("id", "repoItem_" + dom_suffix);
  addedItem.find("#repoRemove_").attr("id", "repoRemove_" + dom_suffix);
  addedItem.find("#repoName_")  .attr("id", "repoName_"   + dom_suffix).find("span").html(repo.name);
  addedItem.find("#repoInPath_").attr("id", "repoInPath_" + dom_suffix).html(repo.incoming_loc);
  addedItem.find("#repoMyLocPath_") .attr("id", "repoMyLocPath_"  + dom_suffix).html(repo.my_loc);
  addedItem.find("#inFolderChooser_").attr("id", "inFolderChooser_" + dom_suffix).click(function() {
    chooseIncomingFolder(repo.name, "repoInPath_" + dom_suffix);
  });
  addedItem.find("#myLocFolderChooser_").attr("id", "myLocFolderChooser_" + dom_suffix).click(function() {
    chooseMyLocFolder(repo.name, "repoMyLocPath_" + dom_suffix);
  });
  
  // attach methods to the visuals
  addedItem.find("#repoRemove_" + dom_suffix).click(removeRepo(dom_suffix, repo.name));
  
  
  if (showSlowly) {
    addedItem.toggle(500);
  }
}

var removeRepo = function(dom_suffix, name) {
  function removeIt() {
    if (confirm("This will stop tracking the repository " + name + ", but it will leave all the files.  Are you sure you want to stop tracking it?")) {
      window.p2pdoc_settings.remove_repo(name);
      window.p2pdoc_settings.save();
      
      var selector = "#repoItem_" + dom_suffix;
      $(selector).hide(500, function() {
        $(this).remove()
      });
    }
  }
  return removeIt;
};

var chooseIncomingFolder = function(repoName, idForPath) {
 Titanium.UI.getCurrentWindow().openFolderChooserDialog(function(selectionResponse) {
   // selectionResponse is an array of folder strings
   if (selectionResponse.length === 0) {
     // cancelled or none chosen, so leave things as-is
   } else {
     if (selectionResponse.length > 1) {
       alert("You chose multiple folders, but I'll only take the first one.");
     }
     window.p2pdoc_settings.change_repo_incoming(repoName, selectionResponse[0]);
     window.p2pdoc_settings.save();
     $("#" + idForPath).html(selectionResponse[0]);
   }
 });
}

var chooseMyLocFolder = function(repoName, idForPath) {
 Titanium.UI.getCurrentWindow().openFolderChooserDialog(function(selectionResponse) {
   // selectionResponse is an array of folder strings
   if (selectionResponse.length === 0) {
     // cancelled or none chosen, so leave things as-is
   } else {
     if (selectionResponse.length > 1) {
       alert("You chose multiple folders, but I'll only take the first one.");
     }
     window.p2pdoc_settings.change_repo_my_loc(repoName, selectionResponse[0]);
     window.p2pdoc_settings.save();
     $("#" + idForPath).html(selectionResponse[0]);
   }
 });
}

$(document).ready(function() {

  try {
  
    var repos = window.p2pdoc_settings.properties().repositories;
    var repo;
    if (repos.length > 0) {
      for (var i = 0; i < repos.length; i++) {
        insertRepo(repos[i], false);
      }
    }
  
    $('#repoAdd_').bind('click', function() {
      
      $('#repo-setup').dialog({
        modal: true,
        width: 550,
        buttons: {
          "Register": function() {
            var new_name = $('#repo-setup #name')[0].value;
            var new_dir_name = window.p2pdoc_settings.fixed_repo_name(new_name);
            var incoming_dir = Titanium.Filesystem.getApplicationDataDirectory() + "/" + new_dir_name;
            var my_dir = Titanium.Filesystem.getApplicationDataDirectory() + "/" + new_dir_name + "_mine";
            
            var added = window.p2pdoc_settings.add_repo(new_name, incoming_dir, my_dir);
            if (added == null) {
              alert("Sorry, that repo has a problem, such as a bad name (eg. already used for another repository, or blank).");
              
            } else {
              window.p2pdoc_settings.save();
              
              insertRepo(added, true);
              
              $( this ).dialog( "close" );
            }
          },
          "Cancel": function() {
            $( this ).dialog( "close" );
          }
        }
      });
    });
    
    
    // bindings for new repository setup
    
    var viewModel = {
      homeLoc: ko.observable(null),
      incomingLoc: ko.observable(null),
      outgoingLoc: ko.observable(null)
    };
  
    viewModel.homePic = ko.dependentObservable(function() {
      return (this.homeLoc() == null ? "images/home-grey.png" : "images/home.png");
    }, viewModel);
    viewModel.incomingPic = ko.dependentObservable(function() {
      return (this.incomingLoc() == null ? "images/people-out-grey.png" : "images/people-out.png");
    }, viewModel);
    viewModel.outgoingPic = ko.dependentObservable(function() {
      return (this.outgoingLoc() == null ? "images/people-in-grey.png" : "images/people-in.png");
    }, viewModel);
  
    $("#homePic").hover(
      function() { $(this).attr("src", "images/home.png"); },
      function() { if (viewModel.homeLoc() == null) { $(this).attr("src", "images/home-grey.png"); } }
    ).click(function() {
      if (viewModel.homeLoc() == null) {
        // turn it on
        viewModel.homeLoc("");
        $('#homeLocHolder').show(500);
      } else {
        // turn it off
        viewModel.homeLoc(null);
        $('#homeLocHolder').hide(500);
        viewModel.outgoingLoc(null);
        $('#outgoingLocHolder').hide(500);
      }
    });
  
    $("#incomingPic").hover(
      function() { $(this).attr("src", "images/people-out.png"); },
      function() { if (viewModel.incomingLoc() == null) { $(this).attr("src", "images/people-out-grey.png"); } }
    ).click(function() {
      if (viewModel.incomingLoc() == null) {
        // turn it on
        viewModel.incomingLoc("");
        $('#incomingLocHolder').show(500);
      } else {
        // turn it off
        viewModel.incomingLoc(null);
        $('#incomingLocHolder').hide(500);
      }
    });
  
    $("#outgoingPic").hover(
      function() { $(this).attr("src", "images/people-in.png"); },
      function() { if (viewModel.outgoingLoc() == null) { $(this).attr("src", "images/people-in-grey.png"); } }
    ).click(function() {
      if (viewModel.outgoingLoc() == null) {
        // turn it on
        if (viewModel.homeLoc() == null) {
          viewModel.homeLoc("");
          $('#homeLocHolder').show(500);
        }
        viewModel.outgoingLoc("");
        $('#outgoingLocHolder').show(500);
      } else {
        // turn it off
        viewModel.outgoingLoc(null);
        $('#outgoingLocHolder').hide(500);
      }
    });
  
    $("#homePic[title]").tooltip({ position:"bottom center", effect:"slide", direction:"down" });
    $("#incomingPic[title]").tooltip({ effect:"slide" });
    $("#outgoingPic[title]").tooltip({ effect:"slide" });
  
    $('#homePic').dataBind({ attr: { src: 'homePic' } });
    $('#incomingPic').dataBind({ attr: { src: 'incomingPic' } });
    $('#outgoingPic').dataBind({ attr: { src: 'outgoingPic' } });
    
    $('#homeLoc').dataBind({text: 'homeLoc'});
    $('#incomingLoc').dataBind({text: 'incomingLoc'});
    $('#outgoingLoc').dataBind({text: 'outgoingLoc'});
    
    $('#homeLocInput').dataBind({value: 'homeLoc'});
    $('#incomingLocInput').dataBind({value: 'incomingLoc'});
    $('#outgoingLocInput').dataBind({value: 'outgoingLoc'});
  
    // activate knockout.js
    ko.applyBindings(viewModel);
    
    
  } catch (e) {
    alert('error: ' + e);
  }
  
});

</script>
</head>

<body>

<a href="index.html" class="ui-state-default" style="float:right;">Done</a>
  
<div id="repoList">
  <div id="repoItem_" class="repoItem">
    <img src="images/button-red-x.png" title="Remove" alt="Remove" id="repoRemove_" class="repoRemove">
    <span id="repoName_"><span class="repoInfo"></span></span>
    <table>
      <tr>
        <td><span class="repoInfo">Incoming</span></td>
        <td>
          <span id="repoInPath_" class="repoInfo"></span>
          <a href="#" id="inFolderChooser_" class="repoAct">(change)</a>
        </td>
      </tr>
      <tr>
        <td><span class="repoInfo">My Copy</span></td>
        <td>
          <span id="repoMyLocPath_" class="repoInfo"></span>
          <a href="#" id="myLocFolderChooser_" class="repoAct">(change)</a>
        </td>
      </tr>
    </table>
  </div>
</div>

<img src="images/button-green-plus.png" title="Add" alt="Add" id="repoAdd_" class="repoAdd">

<div id="dialog-form" title="Repository" style="display:none;">
  <form>
    <fieldset>
      <label>Label</label>
      <input type="text" id="name" name="name"/>
    </fieldset>
  </form>
</div>

<a href="index.html" class="ui-state-default" style="float:right;">Done</a>

<div id="repo-setup" title="Repository" style="display:none;">
  <div style="width:500px; height:120px; text-align:center;">
    <div style="float:left;">
      Name
      <br/>
      <input type="text" id="name" size="15">
    </div>
    <div>
      <img id="homePic" src="images/home-grey.png" style="float:center;" title="This is to keep your own copy of the data."/>
      <br/>
      <div id="homeLocHolder" style="display:none; float:center;">
        <span id="homeLoc"></span><input type="text" id="homeLocInput">
      </div>
    </div>
  </div>
  <div>
    <div style="width:250px; height:240px; float:left; text-align:right;">
      <img id="incomingPic" src="images/people-out-grey.png" title="This is if you're receiving copies of this data from other people."/>
      <br/>
      <div id="incomingLocHolder" style="display:none;">
        <span id="incomingLoc"></span><input type="text" id="incomingLocInput">
      </div>
    </div>
    <div style="width:250px; height:240px; float:right; text-align:center;">
      <img id="outgoingPic" src="images/people-in-grey.png" title="This is to send copies of your data to other people."/>
      <br/>
      <div id="outgoingLocHolder" style="display:none;">
        <span id="outgoingLoc"></span><input type="text" id="outgoingLocInput">
      </div>
    </div>
  </div>
</div>

</body>
</html>
