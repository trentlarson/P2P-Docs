<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>

<link rel="stylesheet" type="text/css" href="css/p2pdocs.css" />

<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>
<script type="text/javascript" src="js/stacktrace.js"></script>
<script type="text/javascript" src="js/p2pdocs.js"></script>

<script type="text/ruby" src="test/ruby/sample_repos_versioned.rb"></script>
<script type="text/ruby" src="ruby/settings.rb"></script>

<script type="text/ruby">
  window.p2pdoc_settings = Settings.new(Titanium.App.Properties.getString("settings-dir"))
  window.p2pdoc_test_versioned = lambda { |content_dir| SampleReposVersioned.create(Titanium.Filesystem.getFile(Titanium.App.getHome(), "Resources"), content_dir, Titanium.Filesystem.getApplicationDataDirectory()) }
</script>

<script type="text/javascript">
  var BACKUP_FILE = 'settings.yaml.bak';
  var BACKUP_PROP = '//settings-dir-bak';

  function restoreRegularOperation() {
    try {
      
      // restore if the settings-dir property was backed-up
      if (Titanium.App.Properties.hasProperty(BACKUP_PROP)) {
        Titanium.App.Properties.setString('settings-dir', Titanium.App.Properties.getString(BACKUP_PROP));
      } else {
        Titanium.App.Properties.setString('settings-dir', Titanium.Filesystem.getApplicationDataDirectory().toString());
      }
      
      // restore if the settings file was backed-up
      var settingsFile = Titanium.Filesystem.getFile(window.p2pdoc_settings.settings_file());
      if (settingsFile.exists()) {
        settingsFile.deleteFile();
      }
      var backupFile = Titanium.Filesystem.getFile(window.p2pdoc_settings.data_dir(), BACKUP_FILE);
      if (backupFile.exists()) {
        // note that 'rename' threw an error
        backupFile.move(settingsFile.toString());
      }
      
      alert("All set to regular environment.");
    } catch (e) {
      p2pdocsHandleError(e);
    }
  }

  function setupTestForNewInstall() {
    try {
      var settingsFile = Titanium.Filesystem.getFile(window.p2pdoc_settings.settings_file());
      if (settingsFile.exists()) {
        var backupFile = Titanium.Filesystem.getFile(window.p2pdoc_settings.data_dir(), BACKUP_FILE);
        if (backupFile.exists()) {
          backupFile.deleteFile();
        }
        // note that 'rename' threw an error
        settingsFile.move(backupFile.toString());
      }
      alert("All set to test environment for new install.");
    } catch (e) {
      p2pdocsHandleError(e);
    }
  }

  function setupTestForVersionedFiles() {
    try {
      if (Titanium.App.Properties.hasProperty('settings-dir')
          && !Titanium.App.Properties.hasProperty(BACKUP_PROP)) {
        Titanium.App.Properties.setString(BACKUP_PROP, Titanium.App.Properties.getString('settings-dir'));
      }
      var settingsDir = Titanium.Filesystem.getFile(Titanium.App.getHome(), 'sample-repos-versioned').toString();
      Titanium.App.Properties.setString('settings-dir', settingsDir);
      window.p2pdoc_test_versioned(Titanium.App.getHome());
      alert("All set for test environment for versioned files.");
    } catch (e) {
      p2pdocsHandleError(e);
    }
  }

  $(document).ready(function() {
    try {
      $('#everything').show('slide', { direction: "down" }, 500);
      $('#restore-env').click(function(){ restoreRegularOperation(); });
      $('#setup-test-env-for-new-install').click(function(){ setupTestForNewInstall(); });
      $('#restart').click(function(){ Titanium.App.restart(); });
      $('#setup-test-env-for-versioned-files').click(function(){ setupTestForVersionedFiles(); });
    } catch (e) {
      p2pdocsHandleError(e);
    }
  });
  
</script>

</head>
<body>
  
<div id="everything">

  <a href="repositories.html" style="float:right;">Done</a>
  
  <br/>
  <span id="restore-env">Switch to regular application.</span>
  
  <br/>
  <br/>
  <span id="setup-test-env-for-new-install">Switch to test for a newly installed application.</span> <a href="junk" id="restart">(restart)</a>
  
  <br/>
  <br/>
  <span id="setup-test-env-for-versioned-files">Switch to test for versioned files.</span>
  <br/>
  This test has versioned files.
  
  
</div>
</body>
</html>