<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title></title>

<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>

<link type="text/css" href="css/smoothness/jquery-ui-1.8.13.custom.css" rel="stylesheet"/>

<script type="text/ruby"       src="ruby/settings.rb"></script>
<script type="text/ruby"       src="ruby/updates.rb"></script>

<script type="text/ruby">
  window.p2pdoc_settings = Settings.new(Titanium.Filesystem.getApplicationDataDirectory())
  window.p2pdoc_all_diffs_json = Updates.strings_arrays_hashes_json(Updates.all_repo_diffs(window.p2pdoc_settings))
</script>

<script type="text/javascript">

//Titanium.UI.getWindows()[0].showInspector()
var Ti = {fs: Titanium.Filesystem, api:Titanium.API};

function all_props(the_obj) {
  var str = "";
  for (prop in the_obj) {
    str += prop + " value: "+ the_obj[prop]+"\n";
  }
  return str;
}

$(document).ready(function() {

  try {
    var all_diffs = JSON.parse(window.p2pdoc_all_diffs_json);
    if (all_diffs.length > 0) {

      $('#diff').show();
      $('#same').hide();

      // declare the repo variables for data and DOM elements
      var repoCount, oneRepoDiffs, repoName, repoDiffList, repoDiffCount;
      var repoTemplate, addedRepo;
      // declare the diff variables for data and DOM elements
      var diffSet;
      var diffTemplate, addedDiff;
      
      repoCount = all_diffs.length;
      repoTemplate = $('#repoList #repo_');
      
      for (var repoNum = 0; repoNum < repoCount; repoNum++) {
        oneRepoDiffs = all_diffs[repoNum];
        repoName = oneRepoDiffs.name;
        repoDiffList = oneRepoDiffs.diffs;
        
        addedRepo = repoTemplate.clone();
        addedRepo.insertBefore(repoTemplate);
        addedRepo.show();
        addedRepo.attr("id", "repo_" + repoNum);
        addedRepo.find("#repoName_").attr("id", "repoName_" + repoNum).html(repoName);
        addedRepo.find("#repoDiffCount_").attr("id", "repoDiffCount_" + repoNum).html(repoDiffCount);
        
        repoDiffCount = repoDiffList.length;
        diffTemplate = addedRepo.find('#diff_');
        
        for (var diffNum = 0; diffNum < repoDiffCount; diffNum++) {
          diffSet = repoDiffList[diffNum];
          
          addedDiff = diffTemplate.clone();
          addedDiff.insertBefore(diffTemplate);
          addedDiff.show();
          addedDiff.attr("id", "diff_" + diffNum);
          
          addedDiff.find("#diffPath_").attr("id", "diffPath_" + diffNum).html(diffSet.path);
          if (diffSet.contents != null) {
            // show the count
            addedDiff.find("#diffCount_").attr("id", "diffCount_" + diffNum).html(diffSet.contents.length);
            // populate the contents
            var fileList = "";
            for (var fileNum = 0, fileCount = diffSet.contents.length; fileNum < fileCount; fileNum++) {
              fileList += "<li>" + diffSet.contents[fileNum] + "</li>\n";
            }
            addedDiff.find("a").next().append(fileList).hide();
            // add a toggling function
            addedDiff.find("a").click(function() {
              $(this).next().toggle(500);
            }).show();
          }
        }
      }
    }

    // click to toggle panel
    $('.panelHeader').click(function() {
      $(this).next().toggle(500);
      return false;
    }).next().hide();

  } catch (e) {
    alert('error: ' + e);
  }

});
</script>
</head>
<body>
<h1>Updates</h1>

<a href="index.html">Index</a>

<h4 id="same">Nothing to see.</h4>
<h4 id="diff" style="display:none;">You've got changes!</h4>

<div id="repoList">
  <div id="repo_" class="accordion" style="display:none;">
    <h3 class="panelHeader">
      <a href="#">
        <span id="repoName_">repo</span>
        <span id="repoDiffCount_">count</span>
      </a>
    </h3>
    <div>
      <ul>
        <li id="diff_" style="display:none;">
          <span id="diffPath_">path</span>
          <a href="#" style="display:none;">contains <span id="diffCount_">count</span> files</a>
          <ul></ul>
        </li>
      </ul>
    </div>
  </div>
</div>

</body>
</html>
